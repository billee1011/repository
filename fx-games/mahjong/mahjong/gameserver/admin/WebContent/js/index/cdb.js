
function des(key,message,encrypt,mode,iv,padding){var spfunction1=new Array(0x1010400,0,0x10000,0x1010404,0x1010004,0x10404,0x4,0x10000,0x400,0x1010400,0x1010404,0x400,0x1000404,0x1010004,0x1000000,0x4,0x404,0x1000400,0x1000400,0x10400,0x10400,0x1010000,0x1010000,0x1000404,0x10004,0x1000004,0x1000004,0x10004,0,0x404,0x10404,0x1000000,0x10000,0x1010404,0x4,0x1010000,0x1010400,0x1000000,0x1000000,0x400,0x1010004,0x10000,0x10400,0x1000004,0x400,0x4,0x1000404,0x10404,0x1010404,0x10004,0x1010000,0x1000404,0x1000004,0x404,0x10404,0x1010400,0x404,0x1000400,0x1000400,0,0x10004,0x10400,0,0x1010004);var spfunction2=new Array(-0x7fef7fe0,-0x7fff8000,0x8000,0x108020,0x100000,0x20,-0x7fefffe0,-0x7fff7fe0,-0x7fffffe0,-0x7fef7fe0,-0x7fef8000,-0x80000000,-0x7fff8000,0x100000,0x20,-0x7fefffe0,0x108000,0x100020,-0x7fff7fe0,0,-0x80000000,0x8000,0x108020,-0x7ff00000,0x100020,-0x7fffffe0,0,0x108000,0x8020,-0x7fef8000,-0x7ff00000,0x8020,0,0x108020,-0x7fefffe0,0x100000,-0x7fff7fe0,-0x7ff00000,-0x7fef8000,0x8000,-0x7ff00000,-0x7fff8000,0x20,-0x7fef7fe0,0x108020,0x20,0x8000,-0x80000000,0x8020,-0x7fef8000,0x100000,-0x7fffffe0,0x100020,-0x7fff7fe0,-0x7fffffe0,0x100020,0x108000,0,-0x7fff8000,0x8020,-0x80000000,-0x7fefffe0,-0x7fef7fe0,0x108000);var spfunction3=new Array(0x208,0x8020200,0,0x8020008,0x8000200,0,0x20208,0x8000200,0x20008,0x8000008,0x8000008,0x20000,0x8020208,0x20008,0x8020000,0x208,0x8000000,0x8,0x8020200,0x200,0x20200,0x8020000,0x8020008,0x20208,0x8000208,0x20200,0x20000,0x8000208,0x8,0x8020208,0x200,0x8000000,0x8020200,0x8000000,0x20008,0x208,0x20000,0x8020200,0x8000200,0,0x200,0x20008,0x8020208,0x8000200,0x8000008,0x200,0,0x8020008,0x8000208,0x20000,0x8000000,0x8020208,0x8,0x20208,0x20200,0x8000008,0x8020000,0x8000208,0x208,0x8020000,0x20208,0x8,0x8020008,0x20200);var spfunction4=new Array(0x802001,0x2081,0x2081,0x80,0x802080,0x800081,0x800001,0x2001,0,0x802000,0x802000,0x802081,0x81,0,0x800080,0x800001,0x1,0x2000,0x800000,0x802001,0x80,0x800000,0x2001,0x2080,0x800081,0x1,0x2080,0x800080,0x2000,0x802080,0x802081,0x81,0x800080,0x800001,0x802000,0x802081,0x81,0,0,0x802000,0x2080,0x800080,0x800081,0x1,0x802001,0x2081,0x2081,0x80,0x802081,0x81,0x1,0x2000,0x800001,0x2001,0x802080,0x800081,0x2001,0x2080,0x800000,0x802001,0x80,0x800000,0x2000,0x802080);var spfunction5=new Array(0x100,0x2080100,0x2080000,0x42000100,0x80000,0x100,0x40000000,0x2080000,0x40080100,0x80000,0x2000100,0x40080100,0x42000100,0x42080000,0x80100,0x40000000,0x2000000,0x40080000,0x40080000,0,0x40000100,0x42080100,0x42080100,0x2000100,0x42080000,0x40000100,0,0x42000000,0x2080100,0x2000000,0x42000000,0x80100,0x80000,0x42000100,0x100,0x2000000,0x40000000,0x2080000,0x42000100,0x40080100,0x2000100,0x40000000,0x42080000,0x2080100,0x40080100,0x100,0x2000000,0x42080000,0x42080100,0x80100,0x42000000,0x42080100,0x2080000,0,0x40080000,0x42000000,0x80100,0x2000100,0x40000100,0x80000,0,0x40080000,0x2080100,0x40000100);var spfunction6=new Array(0x20000010,0x20400000,0x4000,0x20404010,0x20400000,0x10,0x20404010,0x400000,0x20004000,0x404010,0x400000,0x20000010,0x400010,0x20004000,0x20000000,0x4010,0,0x400010,0x20004010,0x4000,0x404000,0x20004010,0x10,0x20400010,0x20400010,0,0x404010,0x20404000,0x4010,0x404000,0x20404000,0x20000000,0x20004000,0x10,0x20400010,0x404000,0x20404010,0x400000,0x4010,0x20000010,0x400000,0x20004000,0x20000000,0x4010,0x20000010,0x20404010,0x404000,0x20400000,0x404010,0x20404000,0,0x20400010,0x10,0x4000,0x20400000,0x404010,0x4000,0x400010,0x20004010,0,0x20404000,0x20000000,0x400010,0x20004010);var spfunction7=new Array(0x200000,0x4200002,0x4000802,0,0x800,0x4000802,0x200802,0x4200800,0x4200802,0x200000,0,0x4000002,0x2,0x4000000,0x4200002,0x802,0x4000800,0x200802,0x200002,0x4000800,0x4000002,0x4200000,0x4200800,0x200002,0x4200000,0x800,0x802,0x4200802,0x200800,0x2,0x4000000,0x200800,0x4000000,0x200800,0x200000,0x4000802,0x4000802,0x4200002,0x4200002,0x2,0x200002,0x4000000,0x4000800,0x200000,0x4200800,0x802,0x200802,0x4200800,0x802,0x4000002,0x4200802,0x4200000,0x200800,0,0x2,0x4200802,0,0x200802,0x4200000,0x800,0x4000002,0x4000800,0x800,0x200002);var spfunction8=new Array(0x10001040,0x1000,0x40000,0x10041040,0x10000000,0x10001040,0x40,0x10000000,0x40040,0x10040000,0x10041040,0x41000,0x10041000,0x41040,0x1000,0x40,0x10040000,0x10000040,0x10001000,0x1040,0x41000,0x40040,0x10040040,0x10041000,0x1040,0,0,0x10040040,0x10000040,0x10001000,0x41040,0x40000,0x41040,0x40000,0x10041000,0x1000,0x40,0x10040040,0x1000,0x41040,0x10001000,0x40,0x10000040,0x10040000,0x10040040,0x10000000,0x40000,0x10001040,0,0x10041040,0x40040,0x10000040,0x10040000,0x10001000,0x10001040,0,0x10041040,0x41000,0x41000,0x1040,0x1040,0x40040,0x10000000,0x10041000);var keys=des_createKeys(key);var m=0,i,j,temp,temp2,right1,right2,left,right,looping;var cbcleft,cbcleft2,cbcright,cbcright2
var endloop,loopinc;var len=message.length;var chunk=0;var iterations=keys.length==32?3:9;if(iterations==3){looping=encrypt?new Array(0,32,2):new Array(30,-2,-2);}
else{looping=encrypt?new Array(0,32,2,62,30,-2,64,96,2):new Array(94,62,-2,32,64,2,30,-2,-2);}
if(padding==2)message+="        ";else if(padding==1){temp=8-(len%8);message+=String.fromCharCode(temp,temp,temp,temp,temp,temp,temp,temp);if(temp==8)len+=8;}
else if(!padding)message+="\0\0\0\0\0\0\0\0";result="";tempresult="";if(mode==1){cbcleft=(iv.charCodeAt(m++)<<24)|(iv.charCodeAt(m++)<<16)|(iv.charCodeAt(m++)<<8)|iv.charCodeAt(m++);cbcright=(iv.charCodeAt(m++)<<24)|(iv.charCodeAt(m++)<<16)|(iv.charCodeAt(m++)<<8)|iv.charCodeAt(m++);m=0;}
while(m<len){left=(message.charCodeAt(m++)<<24)|(message.charCodeAt(m++)<<16)|(message.charCodeAt(m++)<<8)|message.charCodeAt(m++);right=(message.charCodeAt(m++)<<24)|(message.charCodeAt(m++)<<16)|(message.charCodeAt(m++)<<8)|message.charCodeAt(m++);if(mode==1){if(encrypt){left^=cbcleft;right^=cbcright;}else{cbcleft2=cbcleft;cbcright2=cbcright;cbcleft=left;cbcright=right;}}
temp=((left>>>4)^right)&0x0f0f0f0f;right^=temp;left^=(temp<<4);temp=((left>>>16)^right)&0x0000ffff;right^=temp;left^=(temp<<16);temp=((right>>>2)^left)&0x33333333;left^=temp;right^=(temp<<2);temp=((right>>>8)^left)&0x00ff00ff;left^=temp;right^=(temp<<8);temp=((left>>>1)^right)&0x55555555;right^=temp;left^=(temp<<1);left=((left<<1)|(left>>>31));right=((right<<1)|(right>>>31));for(j=0;j<iterations;j+=3){endloop=looping[j+1];loopinc=looping[j+2];for(i=looping[j];i!=endloop;i+=loopinc){right1=right^keys[i];right2=((right>>>4)|(right<<28))^keys[i+1];temp=left;left=right;right=temp^(spfunction2[(right1>>>24)&0x3f]|spfunction4[(right1>>>16)&0x3f]|spfunction6[(right1>>>8)&0x3f]|spfunction8[right1&0x3f]|spfunction1[(right2>>>24)&0x3f]|spfunction3[(right2>>>16)&0x3f]|spfunction5[(right2>>>8)&0x3f]|spfunction7[right2&0x3f]);}
temp=left;left=right;right=temp;}
left=((left>>>1)|(left<<31));right=((right>>>1)|(right<<31));temp=((left>>>1)^right)&0x55555555;right^=temp;left^=(temp<<1);temp=((right>>>8)^left)&0x00ff00ff;left^=temp;right^=(temp<<8);temp=((right>>>2)^left)&0x33333333;left^=temp;right^=(temp<<2);temp=((left>>>16)^right)&0x0000ffff;right^=temp;left^=(temp<<16);temp=((left>>>4)^right)&0x0f0f0f0f;right^=temp;left^=(temp<<4);if(mode==1){if(encrypt){cbcleft=left;cbcright=right;}else{left^=cbcleft2;right^=cbcright2;}}
tempresult+=String.fromCharCode((left>>>24),((left>>>16)&0xff),((left>>>8)&0xff),(left&0xff),(right>>>24),((right>>>16)&0xff),((right>>>8)&0xff),(right&0xff));chunk+=8;if(chunk==512){result+=tempresult;tempresult="";chunk=0;}}
return result+tempresult;}
function des_createKeys(key){pc2bytes0=new Array(0,0x4,0x20000000,0x20000004,0x10000,0x10004,0x20010000,0x20010004,0x200,0x204,0x20000200,0x20000204,0x10200,0x10204,0x20010200,0x20010204);pc2bytes1=new Array(0,0x1,0x100000,0x100001,0x4000000,0x4000001,0x4100000,0x4100001,0x100,0x101,0x100100,0x100101,0x4000100,0x4000101,0x4100100,0x4100101);pc2bytes2=new Array(0,0x8,0x800,0x808,0x1000000,0x1000008,0x1000800,0x1000808,0,0x8,0x800,0x808,0x1000000,0x1000008,0x1000800,0x1000808);pc2bytes3=new Array(0,0x200000,0x8000000,0x8200000,0x2000,0x202000,0x8002000,0x8202000,0x20000,0x220000,0x8020000,0x8220000,0x22000,0x222000,0x8022000,0x8222000);pc2bytes4=new Array(0,0x40000,0x10,0x40010,0,0x40000,0x10,0x40010,0x1000,0x41000,0x1010,0x41010,0x1000,0x41000,0x1010,0x41010);pc2bytes5=new Array(0,0x400,0x20,0x420,0,0x400,0x20,0x420,0x2000000,0x2000400,0x2000020,0x2000420,0x2000000,0x2000400,0x2000020,0x2000420);pc2bytes6=new Array(0,0x10000000,0x80000,0x10080000,0x2,0x10000002,0x80002,0x10080002,0,0x10000000,0x80000,0x10080000,0x2,0x10000002,0x80002,0x10080002);pc2bytes7=new Array(0,0x10000,0x800,0x10800,0x20000000,0x20010000,0x20000800,0x20010800,0x20000,0x30000,0x20800,0x30800,0x20020000,0x20030000,0x20020800,0x20030800);pc2bytes8=new Array(0,0x40000,0,0x40000,0x2,0x40002,0x2,0x40002,0x2000000,0x2040000,0x2000000,0x2040000,0x2000002,0x2040002,0x2000002,0x2040002);pc2bytes9=new Array(0,0x10000000,0x8,0x10000008,0,0x10000000,0x8,0x10000008,0x400,0x10000400,0x408,0x10000408,0x400,0x10000400,0x408,0x10000408);pc2bytes10=new Array(0,0x20,0,0x20,0x100000,0x100020,0x100000,0x100020,0x2000,0x2020,0x2000,0x2020,0x102000,0x102020,0x102000,0x102020);pc2bytes11=new Array(0,0x1000000,0x200,0x1000200,0x200000,0x1200000,0x200200,0x1200200,0x4000000,0x5000000,0x4000200,0x5000200,0x4200000,0x5200000,0x4200200,0x5200200);pc2bytes12=new Array(0,0x1000,0x8000000,0x8001000,0x80000,0x81000,0x8080000,0x8081000,0x10,0x1010,0x8000010,0x8001010,0x80010,0x81010,0x8080010,0x8081010);pc2bytes13=new Array(0,0x4,0x100,0x104,0,0x4,0x100,0x104,0x1,0x5,0x101,0x105,0x1,0x5,0x101,0x105);var iterations=key.length>8?3:1;var keys=new Array(32*iterations);var shifts=new Array(0,0,1,1,1,1,1,1,0,1,1,1,1,1,1,0);var lefttemp,righttemp,m=0,n=0,temp;for(var j=0;j<iterations;j++){left=(key.charCodeAt(m++)<<24)|(key.charCodeAt(m++)<<16)|(key.charCodeAt(m++)<<8)|key.charCodeAt(m++);right=(key.charCodeAt(m++)<<24)|(key.charCodeAt(m++)<<16)|(key.charCodeAt(m++)<<8)|key.charCodeAt(m++);temp=((left>>>4)^right)&0x0f0f0f0f;right^=temp;left^=(temp<<4);temp=((right>>>-16)^left)&0x0000ffff;left^=temp;right^=(temp<<-16);temp=((left>>>2)^right)&0x33333333;right^=temp;left^=(temp<<2);temp=((right>>>-16)^left)&0x0000ffff;left^=temp;right^=(temp<<-16);temp=((left>>>1)^right)&0x55555555;right^=temp;left^=(temp<<1);temp=((right>>>8)^left)&0x00ff00ff;left^=temp;right^=(temp<<8);temp=((left>>>1)^right)&0x55555555;right^=temp;left^=(temp<<1);temp=(left<<8)|((right>>>20)&0x000000f0);left=(right<<24)|((right<<8)&0xff0000)|((right>>>8)&0xff00)|((right>>>24)&0xf0);right=temp;for(var i=0;i<shifts.length;i++){if(shifts[i]){left=(left<<2)|(left>>>26);right=(right<<2)|(right>>>26);}
else{left=(left<<1)|(left>>>27);right=(right<<1)|(right>>>27);}
left&=-0xf;right&=-0xf;lefttemp=pc2bytes0[left>>>28]|pc2bytes1[(left>>>24)&0xf]|pc2bytes2[(left>>>20)&0xf]|pc2bytes3[(left>>>16)&0xf]|pc2bytes4[(left>>>12)&0xf]|pc2bytes5[(left>>>8)&0xf]|pc2bytes6[(left>>>4)&0xf];righttemp=pc2bytes7[right>>>28]|pc2bytes8[(right>>>24)&0xf]|pc2bytes9[(right>>>20)&0xf]|pc2bytes10[(right>>>16)&0xf]|pc2bytes11[(right>>>12)&0xf]|pc2bytes12[(right>>>8)&0xf]|pc2bytes13[(right>>>4)&0xf];temp=((righttemp>>>16)^lefttemp)&0x0000ffff;keys[n++]=lefttemp^temp;keys[n++]=righttemp^(temp<<16);}}
return keys;}
function stringToHex(s){var r="0x";var hexes=new Array("0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f");for(var i=0;i<s.length;i++){r+=hexes[s.charCodeAt(i)>>4]+hexes[s.charCodeAt(i)&0xf];}
return r;}
function hexToString(h){var r="";for(var i=(h.substr(0,2)=="0x")?2:0;i<h.length;i+=2){r+=String.fromCharCode(parseInt(h.substr(i,2),16));}
return r;}/*  |xGv00|788676ace76d58ffef5d755f706ab524 */
qcloud=window.qcloud||{};qcloud.cdb=qcloud.cdb||{};qcloud.cdb.dataImport={};qcloud.cdb.dataImport.init=function(){this._inited=true;this.qType="name";this._buildCdbList();this._buildOperList({});this.initEvent();};qcloud.cdb.dataImport.initEvent=function(){var that=this;$("#cdb_data_con").on('click','[md]',function(){var _this=this;if('info'==this.getAttribute('md')){return;}
if($(_this).parent().parent().hasClass('selected')){return;}
$.each($("#cdb_data_con tr"),function(index,elem){$(elem).removeClass('selected');});$(_this).parent().parent().addClass('selected');var md=$(_this).attr('md');if(!md){$("#btn_next_1").addClass("btn_gray_v2").removeClass("btn_blue");md="MD5正在生成中，生成后可进行导入操作";}else{$("#btn_next_1").addClass("btn_blue").removeClass("btn_gray_v2");}
$("#md5_info").text("MD5: "+md).attr("md5",md);});$('.mod_cdb_data_import .ico_return,#backToStep1').click(function(){that.step1({});});$("#btn_import_refresh").click(function(){that._buildCdbList(that.qType);});$("#btn_import_ref_name").click(function(){that.qType='name';that._buildCdbList(that.qType);});$("#btn_import_ref_time").click(function(){that.qType='date';that._buildCdbList(that.qType);});$("#preview_db_btn").click(function(){that.showDbPrevBox();});$('#btn_prev_1').click(function(){that.step1({});});$("#btn_next_1").click(function(){var _this=this;if($(_this).hasClass("btn_gray_v2")){return;}
if($(_this).hasClass('btn_blue')){that.step2({});return;}});$('#more_recent_task').click(function(){$('.mod_content').hide();$('#recent_task_page').show();qcloud.cvmCommon._loadingData('show');that._buildOperList({moduleId:moduleId,startTime:'1970-01-01 00:00:00',rows:100,cont:'#recent_task_page_cont'});$(window).trigger('resize');});$('#recent_task_refresh_btn').click(function(){qcloud.cvmCommon._loadingData('show');that._buildOperList({moduleId:moduleId,startTime:'1970-01-01 00:00:00',rows:100,cont:'#recent_task_page_cont'});$(window).trigger('resize');});$('#recent_task_page_cont').on('click','.data_detail',function(){$('#recent_task_back_btn').trigger('click');var opt={dataFile:$(this).attr("datafile"),dataDb:$(this).attr("datadb"),dataTime:$(this).attr("datatime"),instanceId:$(this).attr("insid"),workId:$(this).attr("workid")};var jindu=parseInt($(this).attr("jindu"),10);if(jindu>=0&&jindu<100){that.step3(opt);}else if(jindu==100){that.step4(opt);}else{return false;}});$('#recent_task_back_btn').click(function(){$('.mod_content').hide();qcloud.cdb.changeLeftTab(1);});};qcloud.cdb.dataImport.step2Init=function(){var $sel=$("#cdb_data_con .selected div");var dfileInfo=$sel.text();var ctime=$sel.attr("ctime");var fname=$sel.attr("fname");var sizestr=$sel.attr("sizestr");var size=$sel.attr("size");var file=$sel.attr("addr");var ip=$sel.attr("ip")||'';dfileInfo=dfileInfo.split('-');$('#db_pwd').val('');$("#data_file").attr("file",file).attr("size",size).attr("ip",ip).text(fname+"("+sizestr+")");$("#data_time").text(ctime);var md5=$("#md5_info").attr("md5");if(!md5){md5="文件仍在上传中，请完成上传后再执行";$("#btn_oper_import").addClass("btn_gray_v2");}
$("#md_info_sp").text(md5);this.buildInsDb();this.step2Event();};qcloud.cdb.dataImport._buildCdbList=function(qType){var _this=this;var params={moduleId:moduleId,qType:qType||_this.qType};$.jsonGetter({url:"/ajax/cdbImport/getCdbFileList.php",data:{moduleId:moduleId,qType:qType||_this.qType},sucCb:function(d){qcloud.cvmCommon._loadingData('hide');if(0===d.retcode){var data=d.data.data;var $con=$("#cdb_data_con");var $btn_next=$("#btn_next_1");if(data&&data.length>0){var htmls=[],i=0,len=data.length,fd,size,fname;if(!(data[0].md5)){$btn_next.addClass("btn_gray_v2").removeClass("btn_blue");}else{$btn_next.removeClass("btn_gray_v2").addClass("btn_blue");}
$("#md5_info").text("MD5: "+(data[0].md5||'MD5正在生成中，生成后可进行导入操作')).attr("md5",data[0].md5||'');htmls.push(['<table class="ui_grid_tbody">','<colgroup></colgroup>','<tbody>'].join(''));for(;i<len;i++){fd=data[i];var s=fd.size;size=_this.formatSize(s);var index=fd.file.lastIndexOf('/');fname=index>0?fd.file.substring(index+1):fd.file;htmls.push(['<tr'+(0===i?' class="selected"':'')+'>','<td>','<div ip="'+(fd.ip||'')+'"'+' addr="'+fd.file+'" md="'+(fd.md5||'')+'" size="'+s+'" sizestr="'+size+'" fname="'+fname+'" ctime="'+fd.createTime.replace(/\-/g,'/')+'">'+fname+'<em>('+size+' - '+fd.createTime.replace(/\-/g,'/')+')</em></div>','</td>','</tr>'].join(''));}
htmls.push(['</tbody>','</table>'].join(''));$con.html(htmls.join(''));}else{$con.html('<p style="padding: 10px;">请通过FTP上传数据文件</p>');$("#md5_info").text("MD5: ");$btn_next.removeClass("btn_blue").addClass("btn_gray_v2");}}else{qcloud.util.showTips({type:'info',text:d.errmsg||'获取文件列表失败，请稍后刷新重试'});}},errCb:function(d){qcloud.cvmCommon._loadingData('hide');qcloud.util.showTips({type:'info',text:'获取文件列表失败，请稍后刷新重试'});}});};qcloud.cdb.dataImport._buildOperList=function(opt){var _this=this;var params={moduleId:moduleId,status:opt.status||2,startTime:opt.startTime||this.changeDate(-2),endTime:opt.endTime||this.changeDate(0),rows:opt.rows||5,offset:opt.offset||1};var $taskCon=opt.cont?$(opt.cont):$(".data_import_task_bd");$.jsonGetter({url:"/ajax/cdbImport/getCdbOperList.php",data:params,sucCb:function(ret){qcloud.cvmCommon._loadingData('hide');if(ret.retcode===0){var total=ret.data.total;var opers=ret.data.data;if(total>0&&opers&&opers.length>0){var i=0,len=opers.length,oper,htmls=[],fname,file;htmls.push(['<table class="ui_grid_tbody">','<colgroup>','<col style="width: 300px">','<col style="width: auto">','<col style="width: 180px">','<col style="width: 100px;">','</colgroup>','<tbody>'].join(''));for(;i<len;i++){oper=opers[i];var index=oper.file.lastIndexOf('/');file=index>0?oper.file.substring(index+1):oper.file;var t=file+'('+_this.formatSize(oper.size)+')';fname=oper.instanceName;htmls.push(['<tr>','<td>','<span><strong>'+t+'</strong>导入<strong>'+fname+'</strong></span>','</td>','<td>','<div class="ui_progress_v2'+(oper.type==3?' ui_progress_v2_error':'')+((oper.type!=3&&oper.jindu==100)?' ui_progress_v2_complete':'')+'">','<div class="progress_inner" style="width:'+(oper.type==3?'30':oper.jindu)+'%;"></div>','</div>','<span class="state_info">'+oper.typeInfo+(oper.type==3?'':(' '+oper.jindu+'%'))+'</span>','</td>','<td>','<span>用时：'+_this.msToDate(oper.costtime||0)+'</span>','</td>','<td>','<a jindu="'+oper.jindu+'" datafile="'+oper.file+'" datadb="'+oper.instanceName+'" datatime="'+oper.createTime+'" insid="'+oper.instanceId+'" workid="'+oper.workid+'" href="javascript:void(0);" class="data_detail">详情</a>','</td>','</tr>'].join(''));}
htmls.push(['</tbody>','</table>'].join(''));$taskCon.html(htmls.join(''));$(".data_import_task_bd .data_detail").click(function(){var opt={dataFile:$(this).attr("datafile"),dataDb:$(this).attr("datadb"),dataTime:$(this).attr("datatime"),instanceId:$(this).attr("insid"),workId:$(this).attr("workid")};var jindu=parseInt($(this).attr("jindu"),10);if(jindu>=0&&jindu<100){_this.step3(opt);}else if(jindu==100){_this.step4(opt);}else{return false;}});}else{$taskCon.html('<tr><td colspan="4" style="height:50px;text-align:center;"><p class="no_data_task empty" style="display:block;color:#c0c0c0;margin-top:0;">近3天内未执行导入任务</p></td></tr>');}}else{qcloud.util.showTips({type:'info',text:'查询近3天内导入任务失败'});$taskCon.html('<tr><td colspan="4" style="height:50px;text-align:center;"><p class="no_data_task empty" style="display:block;color:#c0c0c0;margin-top:0;">查询近3天内导入任务失败</p></td></tr>');}},errCb:function(d){qcloud.cvmCommon._loadingData('hide');qcloud.util.showTips({type:'info',text:'查询近3天内导入任务失败'});$taskCon.html('<tr><td colspan="4" style="height:50px;text-align:center;"><p class="no_data_task empty" style="display:block;color:#c0c0c0;margin-top:0;">查询近3天内导入任务失败</p></td></tr>');}});};qcloud.cdb.dataImport.buildInsDb=function(){var _s=this;qcloud.cvmCommon._loadingData('show');$.jsonGetter({url:"/ajax/cdbImport/getCdbInstDbs.php",data:{moduleId:moduleId},sucCb:function(ret){qcloud.cvmCommon._loadingData('hide');if(ret.retcode===0){var total=ret.data.totalNum,htmlStr='';if(total>0){var list=ret.data.cdbList,len=list.length;i=0;for(;i<len;i++){var ins=list[i];htmlStr+="<tr><td><div class=\"target_cdb\" fixtype='"+ins.type+"' cdbinstid='"+ins.cdbInstId+"' insid='"+ins.instanceId+"' desc='"+ins.instanceDesc+"' vip='"+ins.vip+"' vport='"+ins.vport+"' addrlist='"+$.toJSON(ins.addrList)+"'"+(i===0?(" dbs='"+$.toJSON(ret.data.dbs)+"' restspace='"+ret.data.restspace+"'"):"")+">"+ins.name+"</div></td></tr>";}
$("#step2_ins_con").html(htmlStr);$('#inst_prev_list').html(htmlStr);$('#inst_prev_list tr:first').trigger('click');$("#step2_ins_con .target_cdb").click(function(){var __t=this;var $db_view=$("#step2_db_con"),dbs=$.evalJSON(typeof $(__t).attr('dbs')=='undefined'?"[]":$(__t).attr('dbs')),dblis='<tr><td><div dbname="" num="-">不指定数据库</div></td></tr>',j=0;$("#step2_ins_con tr").removeClass('selected');$(this).parent().parent().addClass('selected');_s.updateCdbInstInfo($(this));if(dbs&&dbs.length>0){if(dbs.length>0){for(;j<dbs.length;j++){dblis+='<tr><td><div dbname="'+dbs[j].db+'" num="'+dbs[j].tablenum+'">'+dbs[j].db+'</div></td></tr>';}
$db_view.html(dblis);var restspace=_s.formatSize($(__t).attr("restspace"));$("#ins_rest_space").text("当前剩余 "+restspace+" 空间");$("#step2_db_con div").click(function(){var _this=this;if($(_this).parent().parent().hasClass('selected')){return;}
_s.updateCdbDbtInfo($(_this));$("#step2_db_con tr").removeClass('selected');$(this).parent().parent().addClass('selected');});$("#step2_db_con div:first").click();}else{$db_view.html('<tr><td><div>没有数据</div></td></tr>');}}else{$.jsonGetter({url:"/ajax/cdbImport/getOneCdbInstDbsByInstId.php",data:{moduleId:moduleId,instanceId:$(__t).attr("cdbinstid")},sucCb:function(ret){if(ret.retcode===0){dbs=ret.data.dbs;var restspace=_s.formatSize(ret.data.restspace);$("#ins_rest_space").text("当前剩余 "+restspace+" 空间");if(dbs.length>0){for(;j<dbs.length;j++){dblis+='<tr><td><div dbname="'+dbs[j].db+'" num="'+dbs[j].tablenum+'">'+dbs[j].db+'</div></td></tr>';}
$db_view.html(dblis);$("#step2_db_con div").click(function(){var _this=this;if($(_this).parent().parent().hasClass('selected')){return;}
_s.updateCdbDbtInfo($(_this));$("#step2_db_con tr").removeClass('selected');$(this).parent().parent().addClass('selected');});$("#step2_db_con div:first").click();}else{$db_view.html('<tr><td><div>没有数据</div></td></tr>');$("#db_info_op").text("数据库为空");$("#db_manage").addClass("disable").css('color','#bbb').removeAttr("target");}}else{qcloud.util.showTips({type:'info',text:'系统繁忙，请稍后重试（code:'+ret.retcode+')'});}},errCb:function(d){qcloud.util.showTips({type:'info',text:'系统繁忙，请稍后重试'});}});}});$("#step2_ins_con .target_cdb:first").click();}else{$('#inst_prev_list').html("<tr><td><div>没有实例</div></td></tr>");$("#step2_ins_con").html("<tr><td><div>没有实例</div></td></tr>");$("#db_manage").addClass("disable").css('color','#bbb').removeAttr("target");}}else{qcloud.util.showTips({type:'info',text:'系统繁忙，请稍后重试（code:'+ret.retcode+')'});}},errCb:function(d){qcloud.cvmCommon._loadingData('hide');qcloud.util.showTips({type:'info',text:'系统繁忙，请稍后重试'});}});};qcloud.cdb.dataImport.step2Event=function(){var _s=this;$("#btn_oper_import").click(function(){var _this=this;if($(_this).hasClass('btn_gray_v2')){return;}
if(!($("#db_pwd").val())){qcloud.util.showTips({type:'info',text:'CDB密码不能为空'});return;}
var params={moduleId:moduleId,instanceId:$("#step2_ins_con .selected .target_cdb").attr("cdbinstid"),queryType:1};$.jsonGetter({url:"/ajax/cdbImport/queryCdbCapacity.php",data:params,sucCb:function(ret){var num=ret.data.waiting_task_num;if(num===0){$("#step_1_err").css("visibility","visible");}else{var $selInsLi=$("#step2_ins_con .selected .target_cdb"),$selDbLi=$("#step2_db_con .selected div");var tmp=$("#data_file").attr("file");var index=tmp.lastIndexOf('/');file=index>0?tmp.substring(index+1):tmp;var dbname=$selDbLi.attr("dbname")?$selDbLi.attr("dbname"):"--";var info=_s.getSelInsDbInfo(),url="/cdb_list.php?"+$.param(info);var htmls='<div class="fn_pop_txt_con">'+'<p>导入的文件：'+file+'</p>'+'<p>目标CDB实例：'+$selInsLi.text()+'</p>'+'<p>目标数据库：'+dbname+'</p>'+'<p>仅支持增量导入数据，如果数据库内有废弃数据，请先清空数据库后再执行导入操作。</p>'+'<p>导入操作不允许回滚，你确认要执行数据导入吗？</p>'+'</div>';var token=$.getACSRFToken()+'';var params={moduleId:moduleId,cdbInstanceName:$selInsLi.text(),instanceId:$selInsLi.attr("cdbinstid"),path:$("#data_file").attr("file"),dbName:$selDbLi.attr("dbname")||"",filemd5:$("#md_info_sp").text(),fileSize:$("#data_file").attr("size"),ip:$("#data_file").attr("ip")||'',dbUser:$("#db_user").text(),cdb_pwd:stringToHex(des(token,$("#db_pwd").val(),1))};_s.showConfirmBox(htmls,params,function(ret){if(ret.retcode===0){var taskId=ret.data.taskId;_s._workId=ret.data.workid;if(!_s._workId){_s._getWorkId(moduleId,taskId);}else{_s.step3({});}}else if(ret.retcode==9511){$("#step_2_err").css("visibility","visible");$(_this).removeClass("btn_gray_v2");}else if(ret.retcode==9524||ret.retcode==75004){qcloud.util.showTips({type:'info',text:"密码错误，请重新输入密码"});$("#pwd_error_info").css("visibility","visible");$(_this).removeClass("btn_gray_v2");}else if(ret.retcode==9541){qcloud.util.showTips({type:'info',text:"文件为空，请上传正确的文件"});$(_this).removeClass("btn_gray_v2");}else{qcloud.util.showTips({type:'info',text:ret.errmsg});$(_this).removeClass("btn_gray_v2");}});}},errCb:function(ret){qcloud.util.showTips({type:'info',text:ret.errmsg||"系统繁忙，请稍后重试（code:"+ret.retcode+")"});$(_this).removeClass("btn_gray_v2").addClass("btn_blue");}});});};qcloud.cdb.dataImport.showDbPrevBox=function(){var me=this;var $box=$('#db_prev_box');var $submitBtn=$box.find('.btn_submit');qcloud.cvmCommon._initPopBox($box,[]);$submitBtn.removeClass('btn_white_2').addClass('btn_blue');qcloud.cdb.mask.show();$box.floatdiv({location:"middle",isShowCover:true,confirm_callback:function(){qcloud.cdb.mask.hide();},close_callback:function(){qcloud.cdb.mask.hide();}}).show();me.buildInsDb();if(!me._dbPrevEvent){$('#inst_prev_list').on('click','tr',function(){var $dataEl=$(this).find('div');var dbs=$.evalJSON(typeof $dataEl.attr('dbs')=='undefined'?"[]":$dataEl.attr('dbs'));var html=[];$('#inst_prev_list tr').css('background','');$(this).css('background','#fffee7');if(dbs&&dbs.length){$.each(dbs,function(){html.push('<tr style="cursor:default;"><td><span>'+this.db+'</span></td></tr>');});$('#db_prev_list').html(html.join(''));}else{$.jsonGetter({url:"/ajax/cdbImport/getOneCdbInstDbsByInstId.php",data:{moduleId:moduleId,instanceId:$dataEl.attr("cdbinstid")},sucCb:function(ret){dbs=ret.data.dbs;if(dbs.length>0){$.each(dbs,function(){html.push('<tr style="cursor:default;"><td><span>'+this.db+'</span></td></tr>');});$('#db_prev_list').html(html.join(''));}else{$('#db_prev_list').html('<tr style="cursor:default;"><td><div>没有数据</div></td></tr>');}},errCb:function(d){$('#db_prev_list').html('<tr style="cursor:default;"><td><div>数据加载失败</div></td></tr>');}});}});me._dbPrevEvent=true;}};qcloud.cdb.dataImport.showConfirmBox=function(html,param,callback){var me=this;var $box=$('#import_confirm_box');var $submitBtn=$box.find('.btn_submit');qcloud.cvmCommon._initPopBox($box,[]);$box.find('.j_confirm_cont').html(html);$submitBtn.removeClass('btn_white_2').addClass('btn_blue');$box.floatdiv({location:"middle",isShowCover:true,confirm_callback:function(){if(!$submitBtn.hasClass('btn_blue')){return false;}
$submitBtn.removeClass('btn_blue').addClass('btn_blue_loading').find('span').addClass('ico ico_loading_blue');$.jsonPost({url:'/ajax/cdbImport/startCdbImport.php',data:param,sucCb:function(res){$box.closeFloatDiv();callback(res);},errCb:function(res){if(res){$box.closeFloatDiv();callback(res);}else{$submitBtn.removeClass('btn_blue_loading').addClass('btn_blue').find('span').removeClass('ico ico_loading_blue');qcloud.cvmCommon._popBoxErr($box,res);}}});},close_callback:function(){}}).show();};qcloud.cdb.dataImport.showConfirmBox1=function(confirmCbFn){var $box=$('#import_confirm_box1');var $submitBtn=$box.find('.btn_submit');qcloud.cvmCommon._initPopBox($box,[]);$submitBtn.removeClass('btn_white_2').addClass('btn_blue');$box.floatdiv({location:"middle",isShowCover:true,confirm_callback:function(){$box.closeFloatDiv();confirmCbFn();},close_callback:function(){}}).show();};qcloud.cdb.dataImport._getWorkId=function(moduleId,taskId){var _s=this;var params={moduleId:moduleId,taskId:taskId};$.jsonGetter({url:"/ajax/cdbImport/getWorkId.php",data:params,sucCb:function(ret){_s._workId=ret.data.workid;if(!_s._workId){setTimeout(function(){qcloud.cdb.dataImport._getWorkId(moduleId,taskId);},200);}else{_s.step3({});}},errCb:function(d){qcloud.cdb.dataImport._getWorkId(moduleId,taskId);}});};qcloud.cdb.dataImport.step3Init=function(opt){$("#btn_oper_import").removeClass("btn_gray_v2");var data_file=opt.dataFile||$("#data_file").text();var index=data_file.lastIndexOf('/');var file=index>0?data_file.substring(index+1):data_file;$("#step3_data_file").attr("title",data_file).text(file);var data_time=opt.dataTime||$("#data_time").text();$("#step3_data_time").text(data_time);var data_db=opt.dataDb||$("#step2_ins_con .selected .target_cdb").text();$("#step3_data_db").attr("title",data_db).text(data_db);$("#execut_error").text("").css("visibility","hidden");$('#step3_jindu_info').html(['<li class="ing" id="step1_rd"><span class="text">Step-1 </span><span class="text">拉取数据文件</span><span class="state status"></span></li>','<li class="ing" id="step2_chk"><span class="text">Step-2 </span><span class="text">校验文件md5值和大小</span><span class="state status"></span></li>','<li class="ing" id="step3_imp"><span class="text">Step-3 </span><span class="text">执行数据导入</span><span class="state status"></span></li>'].join(''));this.queryImport(opt);};qcloud.cdb.dataImport.queryImport=function(opt){var _s=this;var params={moduleId:moduleId,workId:opt.workId||_s._workId,instanceId:opt.instanceId||_s._instanceId};$.jsonGetter({url:"/ajax/cdbImport/queryImportCdb.php",data:params,sucCb:function(ret){var data=ret.data;var errno=data.workerrno;var $step1_imp=$("#step1_rd span"),$step2_imp=$("#step2_chk span"),$step3_imp=$("#step3_imp span");if(errno==0){$("#cdb_progress_bar").removeClass("ui_progress_v2_error");$("#cdb_progress_bar .data_progress_value").css("width",data.jindu+"%");$("#cdb_progress_info").text("导入中 "+data.jindu+"%");$("#data_cost").text("用时："+_s.msToDate(data.costtime));if(data.jindu<100){$("#step3_btn span").text("终止");$("#step3_btn a").unbind().click(function(){_s.showConfirmBox1(function(){_s.stopImportCdb(params);});});if(data.stepdesc=="rsyncfile"){$step1_imp.eq(1).parent().addClass("finish");$step1_imp.eq(2).text('进行中');$step2_imp.eq(2).text('未进行');$step3_imp.eq(2).text('未进行');}else if(data.stepdesc=="checkparam"){$step1_imp.eq(2).html('完成');$step1_imp.eq(1).parent().removeClass("finish");$step2_imp.eq(1).parent().addClass("finish");$step2_imp.eq(2).text('进行中');$step3_imp.eq(2).text('未进行');}else if(data.stepdesc=="dumpindata"){$step1_imp.eq(2).html('完成');$step2_imp.eq(2).html('完成');$step1_imp.eq(1).parent().removeClass("finish");$step2_imp.eq(1).parent().removeClass("finish");$step3_imp.eq(1).parent().addClass("finish");$step3_imp.eq(2).text(data.jindu+'%');}}else if(data.jindu==100){_s.step4({});}}else if(errno==9511){qcloud.util.showTips({type:'info',text:"当前同类型任务数已达上限"});$("#execut_error").text("错误提示：当前同类型任务数已达上限").css("visibility","visible");$("#cdb_progress_bar").addClass("ui_progress_v2_error");$("#cdb_progress_bar .data_progress_value").css("width","30%");$step1_imp.eq(2).html('完成');$step2_imp.eq(2).html('完成');$step1_imp.eq(1).parent().removeClass("finish");$step2_imp.eq(1).parent().removeClass("finish");$step3_imp.eq(1).parent().removeClass("finish").addClass('error');$step3_imp.eq(2).text('失败');$("#step3_btn span").text("返回重新导入");_s.fromHistory=true;$("#step3_btn a").unbind().click(function(){_s.step1({});});}else if(errno==9528){qcloud.util.showTips({type:'info',text:"任务正在终止中"});$("#execut_error").text("错误提示："+data.workerror).css("visibility","visible");$("#cdb_progress_bar").addClass("ui_progress_v2_error");$("#cdb_progress_bar .data_progress_value").css("width","30%");$step1_imp.eq(2).html('完成');$step2_imp.eq(2).html('完成');$step1_imp.eq(1).parent().removeClass("finish");$step2_imp.eq(1).parent().removeClass("finish");$step3_imp.eq(1).parent().removeClass("finish").addClass('error');$step3_imp.eq(2).text('失败');$("#step3_btn span").text("返回重新导入");_s.fromHistory=true;$("#step3_btn a").unbind().click(function(){_s.step1({});});}else if(errno==9529){qcloud.util.showTips({type:'info',text:"任务已经终止运行"});$("#execut_error").text("错误提示："+data.workerror).css("visibility","visible");$("#cdb_progress_bar").addClass("ui_progress_v2_error");$("#cdb_progress_bar .data_progress_value").css("width","30%");$step1_imp.eq(2).html('完成');$step2_imp.eq(2).html('完成');$step1_imp.eq(1).parent().removeClass("finish");$step2_imp.eq(1).parent().removeClass("finish");$step3_imp.eq(1).parent().removeClass("finish").addClass('error');$step3_imp.eq(2).text('失败');$("#step3_btn span").text("返回重新导入");_s.fromHistory=true;$("#step3_btn a").unbind().click(function(){_s.step1({});});}else if(errno==9523){qcloud.util.showTips({type:'info',text:"mysql错误"});$("#execut_error").text("错误提示："+data.workerror).css("visibility","visible");$("#cdb_progress_bar").addClass("ui_progress_v2_error");$("#cdb_progress_bar .data_progress_value").css("width","30%");$step1_imp.eq(2).html('完成');$step2_imp.eq(2).html('完成');$step1_imp.eq(1).parent().removeClass("finish");$step2_imp.eq(1).parent().removeClass("finish");$step3_imp.eq(1).parent().removeClass("finish").addClass('error');$step3_imp.eq(2).text('失败');$("#step3_btn span").text("返回重新导入");_s.fromHistory=true;$("#step3_btn a").unbind().click(function(){_s.step1({});});}else if(errno==9520){qcloud.util.showTips({type:'info',text:"导入失败"});$("#execut_error").text("错误提示："+data.workerror||'导入失败').css("visibility","visible");$("#cdb_progress_bar").addClass("ui_progress_v2_error");$("#cdb_progress_bar .data_progress_value").css("width","30%");$step1_imp.eq(2).html('完成');$step2_imp.eq(2).html('完成');$step1_imp.eq(1).parent().removeClass("finish");$step2_imp.eq(1).parent().removeClass("finish");$step3_imp.eq(1).parent().removeClass("finish").addClass('error');$step3_imp.eq(2).text('失败');$("#step3_btn span").text("返回重新导入");_s.fromHistory=true;$("#step3_btn a").unbind().click(function(){_s.step1({});});}else if(errno==9524){qcloud.util.showTips({type:'info',text:"密码错误"});$("#execut_error").text("错误提示：密码错误").css("visibility","visible");$("#cdb_progress_bar").addClass("ui_progress_v2_error");$("#cdb_progress_bar .data_progress_value").css("width","30%");$step1_imp.eq(2).html('完成');$step2_imp.eq(2).html('完成');$step1_imp.eq(1).parent().removeClass("finish");$step2_imp.eq(1).parent().removeClass("finish");$step3_imp.eq(1).parent().removeClass("finish").addClass('error');$step3_imp.eq(2).text('失败');$("#step3_btn span").text("返回重新导入");_s.fromHistory=true;$("#step3_btn a").unbind().click(function(){_s.step1({});});}else if(errno==9527){qcloud.util.showTips({type:'info',text:"没有对应CDB实例"});$("#execut_error").text("错误提示：没有对应CDB实例").css("visibility","visible");$("#cdb_progress_bar").addClass("ui_progress_v2_error");$("#cdb_progress_bar .data_progress_value").css("width","30%");$step1_imp.eq(2).html('完成');$step2_imp.eq(2).html('完成');$step1_imp.eq(1).parent().removeClass("finish");$step2_imp.eq(1).parent().removeClass("finish");$step3_imp.eq(1).parent().removeClass("finish").addClass('error');$step3_imp.eq(2).text('失败');$("#step3_btn span").text("返回重新导入");_s.fromHistory=true;$("#step3_btn a").unbind().click(function(){_s.step1({});});}else if(errno!=0){$("#execut_error").text("错误提示："+data.workerror).css("visibility","visible");$("#cdb_progress_bar").addClass("ui_progress_v2_error");$("#cdb_progress_bar .data_progress_value").css("width","30%");$("#step3_btn span").text("返回重新导入");_s.fromHistory=true;$("#step3_btn a").unbind().click(function(){_s.step1({});});if(data.stepdesc=="rsyncfile"){$step1_imp.eq(1).parent().removeClass("finish").addClass("error");$step1_imp.eq(2).text('失败');$step2_imp.eq(2).text('未进行');$step3_imp.eq(2).text('未进行');}else if(data.stepdesc=="checkparam"){$step1_imp.eq(2).html('完成');$step2_imp.eq(1).parent().removeClass("finish").addClass("error");$step1_imp.eq(1).parent().removeClass("finish");$step2_imp.eq(2).text('失败');$step3_imp.eq(2).text('未进行');}else if(data.stepdesc=="dumpindata"){$step1_imp.eq(2).html('完成');$step2_imp.eq(2).html('完成');$step3_imp.eq(1).parent().removeClass("finish").addClass("error");$step1_imp.eq(1).parent().removeClass("finish");$step2_imp.eq(1).parent().removeClass("finish");$step3_imp.eq(2).text('失败');}}
if(errno==0&&data.jindu<100){setTimeout(function(){qcloud.cdb.dataImport.queryImport(opt);},5000);}},errCb:function(ret){qcloud.util.showTips({type:'info',text:"系统繁忙，请稍后重试（code:"+ret.retcode+")"});_s.fromHistory=true;$("#step3_btn a").unbind().click(function(){_s.step1({});});}});};qcloud.cdb.dataImport.stopImportCdb=function(params){qcloud.util.showTips({type:'loading',text:"正在终止任务"});$.jsonGetter({url:"/ajax/cdbImport/stopImportCdb.php",data:params,sucCb:function(ret){var errno=ret.data.workerrno;if(errno===0){qcloud.util.showTips({type:'succeed',text:"发起终止操作成功，终止需要一个过程，请稍后"});}else if(errno<0){qcloud.util.showTips({type:'error',text:"CDB数据导入终止失败，请重试"});}else{qcloud.util.showTips({type:'info',text:"系统繁忙，请稍后重试（errno:"+errno+")"});}},errCb:function(ret){qcloud.util.showTips({type:'info',text:"系统繁忙，请稍后重试（code:"+ret.retcode+")"});}});};qcloud.cdb.dataImport.step4Init=function(opt){var _s=this;var data_file=opt.dataFile||$("#step3_data_file").text();var index=data_file.lastIndexOf('/');var file=index>0?data_file.substring(index+1):data_file;$("#step4_data_file").attr("title",data_file).text(file);var data_time=opt.dataTime||$("#step3_data_time").text();$("#step4_data_time").text(data_time);var data_db=opt.dataDb||$("#step3_data_db").text();$("#step4_data_db").attr("title",data_db).text(data_db);var time_cost=opt.timeCost||$("#data_cost").text();$("#step4_data_cost").text(time_cost);$("#step4_btn a").unbind().click(function(){_s.fromHistory=true;_s.step1({});});};qcloud.cdb.dataImport.step1=function(){$(".the-step").removeClass("state_doing").removeClass("state_over");$(".the-step-1").addClass("state_doing");$(".mod_import_step").hide();$(".j_step_1").show();$('#muti_area2').attr('disabled',false);$(window).trigger('resize');};qcloud.cdb.dataImport.step2=function(opt){$(".the-step").removeClass("state_doing").removeClass("state_over");$(".the-step-1").addClass("state_over");$(".the-step-2").addClass("state_doing");$(".mod_import_step").hide();$(".j_step_2").show();$('#muti_area2').attr('disabled',true);this.step2Init(opt);$(window).trigger('resize');};qcloud.cdb.dataImport.step3=function(opt){$(".the-step").removeClass("state_doing").removeClass("state_over");$(".the-step-1").addClass("state_over");$(".the-step-2").addClass("state_over");$(".the-step-3").addClass("state_doing");$(".mod_import_step").hide();$(".j_step_3").show();$('#muti_area2').attr('disabled',true);this.step3Init(opt);$(window).trigger('resize');};qcloud.cdb.dataImport.step4=function(opt){$(".the-step").removeClass("state_doing").removeClass("state_over");$(".the-step-1").addClass("state_over");$(".the-step-2").addClass("state_over");$(".the-step-3").addClass("state_over");$(".the-step-4").addClass("state_over");$(".mod_import_step").hide();$(".j_step_4").show();this.step4Init(opt);$(window).trigger('resize');};qcloud.cdb.dataImport.getSelInsDbInfo=function(){var typeMap={"SMALL_HOT":"微型","MID_HOT":"小型","BIG_HOT":"大型"};var $selLi=$("#step2_ins_con tr.selected .target_cdb");var addrList=$.evalJSON($selLi.attr("addrlist"));var info={moduleId:moduleId,instanceName:$selLi.text()||"",cdbInstId:$selLi.attr("cdbinstid")||"",instanceId:$selLi.attr("insid")||"",vip:$selLi.attr("vip")||"",vport:$selLi.attr("vport")||"",ip:addrList[0].ip||"",port:addrList[0].port||"",fix_type:typeMap[$selLi.attr("fixtype")]||""};return info;};qcloud.cdb.dataImport.updateCdbInstInfo=function($li){this._instanceId=$li.attr("cdbinstid");var vip=$li.attr('vip'),vport=$li.attr("vport");$("#cee_ip_port").text(vip+':'+vport);};qcloud.cdb.dataImport.updateCdbDbtInfo=function($li){var num=parseInt($li.attr('num'),10);var $db_info_op=$("#db_info_op");if(num>0){$db_info_op.text("已创建"+num+"张表");var info=this.getSelInsDbInfo(),url;delete info.cdbInstId;delete info.ip;delete info.port;delete info.fix_type;url="/cdb_redirect.php?"+$.param(info);$("#db_manage").removeClass("disable").css('color','').attr("href",url).attr("target","_blank");}else{$db_info_op.text("数据库为空");$("#db_manage").addClass("disable").css('color','#bbb').attr("href","javascript:void(0);").removeAttr("target");}};qcloud.cdb.dataImport.changeDate=function(val){var currdate="";var date=new Date();if(val===0){var month=date.getMonth()+1;month=month<10?("0"+month):month;var day=date.getDate();day=day<10?("0"+day):day;currdate=date.getFullYear()+"-"+month+"-"+day;}else{if(this._chkdate(currdate)){var dates=currdate.split("-");dates[1]=dates[1].replace(/^0/g,'');dates[2]=dates[2].replace(/^0/g,'');currdate=this._dayAddDiff(parseInt(dates[0],10),parseInt(dates[1],10),parseInt(dates[2],10),val);}else{currdate=this._dayAddDiff(parseInt(date.getFullYear(),10),parseInt(date.getMonth()+1,10),parseInt(date.getDate(),10),val);}}
return currdate;};qcloud.cdb.dataImport._chkdate=function(datestr){var lthdatestr;if(datestr!=="")
lthdatestr=datestr.length;else
lthdatestr=0;var tmpy="";var tmpm="";var tmpd="";var status;status=0;if(lthdatestr===0){return false;}
for(i=0;i<lthdatestr;i++){if(datestr.charAt(i)=='-'){status++;}
if(status>2){return false;}
if((status===0)&&(datestr.charAt(i)!='-')){tmpy=tmpy+datestr.charAt(i);}
if((status==1)&&(datestr.charAt(i)!='-')){tmpm=tmpm+datestr.charAt(i);}
if((status==2)&&(datestr.charAt(i)!='-')){tmpd=tmpd+datestr.charAt(i);}}
year=new String(tmpy);month=new String(tmpm);day=new String(tmpd);tempdate=new String(year+month+day);if((tmpy.length!=4)||(tmpm.length>2)||(tmpd.length>2)){return false;}
if(!((1<=month)&&(12>=month)&&(31>=day)&&(1<=day))){return false;}
if(!((year%4)==0)&&(month==2)&&(day==29)){return false;}
if((month<=7)&&((month%2)==0)&&(day>=31)){return false;}
if((month>=8)&&((month%2)==1)&&(day>=31)){return false;}
if((month==2)&&(day==30)){return false;}
return true;};qcloud.cdb.dataImport._dayAddDiff=function(year,month,day,diff){var numDays=new Array(31,28,31,30,31,30,31,31,30,31,30,31);var isLeap=false;var newyear=year;var newmonth=month-1;var n=numDays[newmonth];var newday=day;var newdiff=diff;var ln;if(newmonth===0)
ln=31;else if(newmonth==11)
ln=31;else
ln=numDays[newmonth+1];if(diff!=0){if(year%4==0){if(year%100!=0)
isLeap=true;else{if(year%400==0)
isLeap=true;}}
if(newmonth==1&&isLeap)
++n;if(newmonth==0&&isLeap)
++ln;var newday=day+newdiff;if(newday>0){if(newday>n){newday=newday-n;if(newmonth==11){newmonth=0;newyear+=1;newdiff=newday-1;return this._dayAddDiff(newyear,newmonth+1,1,newdiff);}else{newmonth+=1;newdiff=newday-1;return this._dayAddDiff(newyear,newmonth+1,1,newdiff);}}}else if(newday==0){if(newmonth==0){newmonth=11;newyear+=-1;newday=31;}else{newmonth+=-1;newday=numDays[newmonth];}}else{if(newmonth==0){newmonth=11;newyear+=-1;newdiff=newday;newday=31;return this._dayAddDiff(newyear,newmonth+1,newday,newdiff);}else{newmonth+=-1;newdiff=newday;newday=ln;return this._dayAddDiff(newyear,newmonth+1,newday,newdiff);}}}
var daystring="";daystring+=year;newmonth+=1;if(newmonth<10)
daystring+="-0"+newmonth;else
daystring+="-"+newmonth;if(newday<10)
daystring+="-0"+newday;else
daystring+="-"+newday;return daystring;};qcloud.cdb.dataImport.formatSize=function(s){s=parseInt(s,10);return(s>0&&s<1024)?(s+"Byte"):(s<1024*1024)?(Math.floor(s/(1024))+"KB"):(s<1024*1024*1024)?(Math.floor(s/(1024*1024))+"MB"):(Math.floor(s/(1024*1024*1024))+"GB");};qcloud.cdb.dataImport.msToDate=function(msd){var time=parseFloat(msd);if(null!=time&&""!=time){if(time>60&&time<60*60){time=parseInt(time/60.0)+"分钟"+parseInt((parseFloat(time/60.0)-parseInt(time/60.0))*60)+"秒";}else if(time>=60*60&&time<60*60*24){time=parseInt(time/3600.0)+"小时"+parseInt((parseFloat(time/3600.0)-parseInt(time/3600.0))*60)+"分钟"+parseInt((parseFloat((parseFloat(time/3600.0)-parseInt(time/3600.0))*60)-parseInt((parseFloat(time/3600.0)-parseInt(time/3600.0))*60))*60)+"秒";}else{time=parseInt(time)+"秒";}}else{time="0 时 0 分0 秒";}
return time;};/*  |xGv00|d88e21f442392f66a20cc0da72719dee */
window.qcloud=window.qcloud||{};window.qcloud.cdb=window.qcloud.cdb||{};window.qcloud.cdb.init=function(moduleId){var _this=this;this.cvmList=[];this.wsList=[];this.tempCdbList=[];this.projectPerm=0;this.inited=false;this.sortId='';this.sortType=1;this.moduleId=moduleId;this.projectId=$.cookie("projectId")||'0';this.regionId=$.cookie("regionId")||'1';$.cookie("projectId",this.projectId,{'path':'/','domain':COOKIE_DOMAIN});$.cookie("regionId",this.regionId,{'path':'/','domain':COOKIE_DOMAIN});this.uin=$.cookie('uin');this.contentTable=$('#cont_table_area table');this.allTitles=['cdb_name','cdb_addr','cdb_type','cdb_charset','cdb_capacity','cdb_create_time','cdb_end_time','operation'];this.defaultTitles=['cdb_name','cdb_addr','cdb_type','cdb_charset','cdb_capacity','cdb_create_time','cdb_end_time','operation'];this.map={'cdb_name':'name','cdb_addr':'ipAndPort','cdb_type':'typeCn','cdb_charset':'charset','cdb_capacity':'capacity','cdb_create_time':'addTimeStamp','cdb_end_time':'deadline'};this.titleNames=[{id:'cdb_name',sortable:true,name:'名称'},{id:'cdb_addr',sortable:false,name:'访问地址'},{id:'cdb_type',sortable:false,name:'实例类型'},{id:'cdb_charset',sortable:false,name:'默认字符集'},{id:'cdb_capacity',sortable:true,name:'容量'},{id:'cdb_create_time',sortable:true,name:'创建时间'},{id:'cdb_end_time',sortable:true,name:'到期时间'},{id:'operation',minWidth:210,sortable:false,name:'操作'}];IS_PAID=parseInt(IS_PAID,10)||0;if(IS_PAID){$('#btn_back').hide();}else{$('#btn_back').show();$('[_val=cdb_end_time]').closest('li').hide();$('[v=cdb_end_time]').closest('li').hide();this.titleNames.splice(6,1);}
this.typeMap={"ALL":"所有类型","TBS_DBH128":"高性能版-超微A型","TBS_DBH256":"高性能版-超微B型","TBS_DBH48":"高性能版-微型","TBS_DBH24":"高性能版-小型","TBS_DBH3":"高性能版-A型","TBS_DBH6":"高性能版-B型","TBS_DBH12":"高性能版-C型","TBS_DBH2":"高性能版-大型","SMALL_HOT":"标准版-微型","MID_HOT":"标准版-小型","DBH3":"标准版-标准型","BIG_HOT":"标准版-大型","C32":"单机版-微型","C6":"单机版-小型","C2":"单机版-A型","C3":"单机版-B型","C4":"单机版-C型","C1":"单机版-大型"};this.FtpAddr={"1":"gz.cdb-ftp.opencloud.qq.com","4":"sh.cdb-ftp.opencloud.qq.com"};qcloud.cvmCommon.allTitles=this.allTitles;qcloud.cvmCommon.defaultTitles=this.defaultTitles;qcloud.cvmCommon.titleNames=this.titleNames;this.bindEvent();this.getProjectList();qcloud.cvmCommon.init();qcloud.cvmCommon.createTable=function(){_this.createTable();};qcloud.cvmCommon._checkOpsAvailable=function(){_this._checkOpsAvailable();};qcloud.cvmCommon.showInfo=function(info){_this.showcdbInfo(info);};qcloudTable.init($('.content_main .bd_title_table table'),this.contentTable,this._sortList);qcloud.cvmCommon.resizeSrvArea(1);qcloud.cvmCommon.autoHeight();$(window).resize(function(){if(!window._isTableMode){var $cont;$('.mod_content').each(function(){if('none'!=$(this).css('display')){$cont=$(this);}});if($cont.find('.content_main').height()+106<$(window).height()){$cont.css('height',$(window).height()-106+'px');$(document.body).css('overflow-y','hidden');}else{$cont.css('height','');$(document.body).css('overflow-y','auto');}}});$(window).resize();var pos=window.location.href.indexOf('tab=');if(pos>0){var tab=window.location.href.substr(pos+4)-0;if(tab>=0&&tab<=2){this.changeLeftTab(tab);}}
var _sTypeHtml=[];for(var _p in this.typeMap){_sTypeHtml.push('<li><a href="javascript:void(0);" onclick="return false;" _search_type="1">'+this.typeMap[_p]+'</a></li>');}
$('#search_type_list').html(_sTypeHtml.join(''));$('#search_type_list li:last').addClass('last');};qcloud.cdb.getFromArr=function(arr,key,val){var isKeyMode=(arguments.length===3);var _v;var ret=isKeyMode?null:-1;if(!isKeyMode){val=key;}
$.each(arr,function(k,v){_v=isKeyMode?v[key]:v;if(val==_v){ret=isKeyMode?v:k;}});return ret;};qcloud.cdb.mask=(function(){var _count=1;var $body=$(document.body);return{show:function(zIndex){zIndex=zIndex||1000;var w=$body.width();var h=$body.height();$body.append(['<div class="_z_mask" id="_z_mask_'+(_count++)+'" style="','position:absolute;','left:0;','top:0;','width:'+w+'px;','height:'+h+'px;','background:#000;','opacity:0.8;_filter:alpha(opacity=80);','z-index:'+zIndex,'">',"</div>"].join(''));return _count;},hide:function(id){if(!id){$('._z_mask').remove();}else{$('#_z_mask_'+_count).remove();}},adjust:function(){$('._z_mask').height($(document).height());}};})();qcloud.cdb.getProjectList=function(cbFn){var me=qcloud.cdb;var h=[];param={};$.jsonGetter({url:"/ajax/project/getProjectList.php",data:param,sucCb:function(d){me.projectList=d.data;$.each(d.data,function(k,v){h.push('<option value="'+v.projectId+'" name="'+v.name+'">'+v.name+'</option>');});$('#cdb_project_list').html(h.join(''));me.projectId=$.cookie("projectId");$('#cdb_project_list').val($.cookie("projectId"));me.getRegionList();},errCb:function(d){qcloud.util.showTips({type:"error",text:'加载项目列表失败，请重试'});}});};qcloud.cdb.getRegionList=function(cbFn){var me=qcloud.cdb;me.projectId=$.cookie("projectId");param={projectId:me.projectId};$.jsonGetter({url:"/ajax/cdb/queryCdbListFromAllRegion.php",data:param,sucCb:function(d){me.shTotalNum=d.data.shTotalNum;me.shNoInitNum=d.data.shNoInitNum;me.gzTotalNum=d.data.gzTotalNum;me.gzNoInitNum=d.data.gzNoInitNum;me.list={"1":[me.gzTotalNum+"",me.gzNoInitNum+""],"4":[me.shTotalNum+"",me.shNoInitNum+""]};me.regionId=$.cookie("regionId");$('#select_area_list a').each(function(){var a=me.list[$(this).attr("value")];$(this).find('i').first().replaceWith(a[0]);$(this).find('i').first().replaceWith(a[1]);t=a[0]+"个云数据库实例，"+a[1]+"个设置未初始化密码";$(this).find('.area_item').text(t);});if(me.shTotalNum<=0){$('#select_area_list [value=4]').parent().addClass('disable');$('#muti_area2 [value=4]').attr('disabled',true);}
else{$('#select_area_list [value=4]').parent().removeClass('disable');$('#muti_area2 [value=4]').attr('disabled',false);}
if(me.gzTotalNum<=0){$('#select_area_list [value=1]').parent().addClass('disable');$('#muti_area2 [value=1]').attr('disabled',true);if(me.shTotalNum>0){$.cookie("regionId",4,{'path':'/','domain':COOKIE_DOMAIN});}}
else{$('#select_area_list [value=1]').parent().removeClass('disable');$('#muti_area2 [value=1]').attr('disabled',false);}
$('#select_area_btn span').text($('#select_area_list [value='+$.cookie("regionId")+'] span.area_name').text());$('#muti_area2').val($.cookie("regionId"));me.getData();},errCb:function(d){qcloud.util.showTips({type:"error",test:'获取多地域实例数量失败，请重试'});}});};qcloud.cdb.selectProject=function(cbFn){var me=qcloud.cdb;me.projectId=$('#cdb_project_list').find("option:selected").val();$.cookie("projectId",me.projectId,{'path':'/','domain':COOKIE_DOMAIN});me.getRegionList();me.getData();};qcloud.cdb.selectMultiArea=function(){var me=qcloud.cdb;me.regionId=$('#muti_area').find("option:selected").val();$.cookie("regionId",me.regionId,{'path':'/','domain':COOKIE_DOMAIN});qcloud.cdb.getData();};qcloud.cdb.selectMultiArea2=function(){var me=qcloud.cdb;me.regionId=$('#muti_area2').find("option:selected").val();$.cookie("regionId",me.regionId,{'path':'/','domain':COOKIE_DOMAIN});qcloud.cdb.dataImport.init();qcloud.cdb.getFileListAndFtp();};qcloud.cdb.getData=function(cbFn){var me=qcloud.cdb;me.projectId=$.cookie("projectId");me.regionId=$.cookie("regionId");var instIdList=[];var _getDate=function(str){var tmp=str.split(/\s+/)[0].split('-');var d=new Date(tmp[0],+tmp[1]-1,tmp[2]);tmp=str.split(/\s+/)[1].split(':');d.setHours(tmp[0]);d.setMinutes(tmp[1]);d.setSeconds(tmp[2]);return d;};param={moduleId:me.moduleId,projectId:me.projectId,regionId:me.regionId};qcloud.cvmCommon._loadingData('show');$.jsonGetter({url:"/ajax/queryCdbList.php",data:param,sucCb:function(d){qcloud.cvmCommon._loadingData('hide');me.cvmList=me.wsList=qcloud.cvmCommon.cvmList=d.data.cdbList;me.projectPerm=d.data.changeProject;me.tempCdbList=me.wsList;$.each(me.cvmList,function(){instIdList.push(this.cdbInstId);this.ipAndPort=this.vip+':'+this.vport;this.typeCn=me.typeMap[this.type];this.charset='加载中...';if(IS_PAID){var today=_getDate(HOST_TIME).getTime()||0;var dl=_getDate(this.deadline).getTime()||0;this.leftTime=Math.max(-7,Math.floor((dl-today)/(24*60*60*1000)));}});me.queryCdbCharset(instIdList);me.showGuide();qcloud.cdb.isSearchResult=false;me.pager.set(me.pager.cur,Math.ceil(me.wsList.length/qcloud.cdb.pager.numPerPage));me.createTable();if(me._infoShowedId){me.showcdbInfo(me.cvmList[0]);}
if(me.projectPerm==1){$('#btn_project').show();}
else{$('#btn_project').hide();}
if("function"==typeof cbFn){cbFn();}
setTimeout(function(){qcloudTable.adjustWidth();},100);me.initResetPwd();},errCb:function(d){qcloud.cvmCommon._loadingData('hide');qcloud.util.showTips({type:"error",text:'加载失败，请重试'});}});};qcloud.cdb.queryCdbCharset=function(idList){var me=this;$.jsonGetter({url:"/ajax/CdbCharset/batchQueryCdbCharset.php",data:{moduleId:moduleId,instanceIdList:idList},sucCb:function(d){if(0===d.retcode){$.each(d.data,function(k,v){var id=this.instanceId;var o=me.getFromArr(me.wsList,'cdbInstId',id);o.charset=(0===this.errcode?this.charset:'获取失败');$('[_charset='+id+']').text(o.charset);});}else{qcloud.util.showTips({type:"error",text:'获取CDB字符集失败，请稍后再试。'});}},errCb:function(){qcloud.util.showTips({type:"error",text:'获取CDB字符集失败，请稍后再试。'});}});};qcloud.cdb.showGuide=function(){$.jsonGetter({url:"/ajax/getUserFeature.php",data:{feature:"cdb.initset"},sucCb:function(d){if(0===d.retcode){if(0===d.data.status){qcloud.cdb.__showGuideDialog();}}},errCb:function(){}});};qcloud.cdb.__showGuideDialog=function(){var targetEl=$('[_init=0]');if(!targetEl.length||!qcloud.cvmCommon.cvmList.length){return;}
var l,t,rect;var $win=$(window);targetEl=targetEl[0];$('#guide_dialog').parent().show();$('#guide_dialog').find('a')[0].onclick=function(){qcloud.cdb.showDbInitBox($(targetEl).closest('tr').attr('seq'));qcloud.cdb.closeGuide();};$win.on('resize',function(){rect=targetEl.getBoundingClientRect();l=rect.left-35+$win.scrollLeft()-3;t=rect.top+$win.scrollTop()-3;$('#guide_dialog').css({left:l,top:t});});$(window).trigger('resize');};qcloud.cdb.closeGuide=function(){$('#guide_dialog').parent().hide();};qcloud.cdb.createTable=function(){var me=qcloud.cdb,titleTable=[],titles=qcloud.cvmCommon.getRowTitle(),allTitles=me.allTitles,titleNames=me.titleNames,$contentTable=me.contentTable;var page=me.pager.get();for(var i in titleNames){for(var j in titles){if(titleNames[i]['id']==titles[j]){titleTable.push(titleNames[i]);break;}}}
titleTable.noOperation=true;qcloudTable.setTitle(titleTable,{id:me.sortId,type:me.sortType==1?'down':'up'});if(me.cvmList.length){$('.table_blank').hide();$contentTable.find('tbody').html($.tmpl(qcloud.cdbTmpl,{list:qcloud.cvmCommon.cvmList.slice(0,me.pager.numPerPage),titles:titleTable,isPaid:IS_PAID,map:me.map})).end().show();$contentTable.parent().show();}else{$contentTable.hide();$('.table_blank').find('.text').html(false===me.isSearchResult?'当前条件下没有任何实例，请切换过滤条件 或 <a class="link" target="_blank" href="/shoppingcart/shop.php?tab=cdb">立即购买</a>':'没有搜索到符合条件的实例');$('.table_blank').show();$contentTable.parent().hide();qcloud.cvmCommon.resizeSrvArea(1);$('#mod_monitor_frm .ico').hide();}
qcloudTable.adjustWidth();me._checkOpsAvailable();if(!me.inited){me.inited=true;}};qcloud.cdb.bindEvent=function(){var me=qcloud.cdb,$contentTable=me.contentTable;$('#btn_rename').click(function(){if("1"==IS_LOCKED){qcloud.cdb.showChangingBox();return;}
if(!$(this).hasClass('btn_disable_v2')){me.rename.show();}});$('#btn_back').click(function(){if(!$(this).hasClass('btn_disable_v2')){me.showReturnBox();}});$('#btn_project').click(function(){if(!$(this).hasClass('btn_disable_v2')){me.showProjectBox();}});$('#btn_refresh').click(function(){$('#returnList a').click();});qcloud.cdb.pager.events();qcloud.cdb.search.events();qcloud.cdb.rename.events();$('#yellow_tip').click(function(){$(this).parent().hide();});$('#search_type_btn').on('click',function(e){$('#search_type_list').toggle();e.stopPropagation();});$('#select_area_btn').on('click',function(e){$('#select_area_list').toggle();$('#change_area').addClass('change_area_select');e.stopPropagation();});$(document.body).on('click',function(){$('#search_type_list').hide();$('#select_area_list').hide();$('#change_area').removeClass('change_area_select');});$(document.body).on('click','[_search_type]',function(){$('#search_type_btn span').text($(this).text());$('#change_area').removeClass('change_area_select');});$(document.body).on('click','[_select_area]',function(){if(!$(this).parent().hasClass('disable')){var me=qcloud.cdb;$('#select_area_btn span').text($(this).find('span.area_name').text());me.regionId=$(this).attr('value');$.cookie("regionId",me.regionId,{'path':'/','domain':COOKIE_DOMAIN});qcloud.cdb.getData();}});$(document.body).on('click','.j_hide_left',function(){qcloud.cvmCommon.hideLeftNav();$(this).hide();$('.mod_content').css({'margin-left':'15px'});});$('#slide_nav_min a').click(function(){$('.mod_content').css({'margin-left':'210px'});$('.j_hide_left').show();});$('#cdb_xfee_type').on('change',function(){if("0"==$('#cdb_xfee_type option:checked').val()){$('#cdb_xfee_val').html(['<option value="12">1</option>','<option value="24">2</option>','<option value="36">3</option>'].join(''));}else{$('#cdb_xfee_val').html(['<option value="1">1</option>','<option value="2">2</option>','<option value="3">3</option>','<option value="4">4</option>','<option value="5">5</option>','<option value="6">6</option>','<option value="7">7</option>','<option value="8">8</option>','<option value="9">9</option>'].join(''));}
$('#cdb_xfee_val')[0].onchange();});};qcloud.cdb.getFileListAndFtp=function(){$('#ftp_addr').html(qcloud.cdb.getFtpAddr($.cookie('regionId')));};qcloud.cdb.rename={events:function(){$(document).on('mouseover','.name_text',function(){clearTimeout(this._timer);$(this).find('.j_btn_edit').show();});$(document).on('mouseout','.name_text',function(){var that=this;this._timer=setTimeout(function(){$(that).find('.j_btn_edit').hide();},100);});$(document).on('click','.j_btn_edit',function(e){if("1"==IS_LOCKED){qcloud.cdb.showChangingBox();return;}
var $editPad=$(this).next('.edit_pad');var name=$(this).prev('span').html();var input=$editPad.find('input')[0];$(this).hide();$('.edit_pad').hide();$editPad.show();$editPad.find('.num').text(20-name.length);$(input).val(name);qcloud.util.selectText(input,0,100);input.focus();});$(document).on('click',function(e){qcloud.cdb.__isBtn=('a'==e.target.tagName.toLowerCase())?true:false;});$(document.body).on('click','.edit_pad',function(e){qcloud.cdb.__isBtn=true;e.stopPropagation();return false;});$('.body').on('click','.j_rename_cancel',function(e){$(this).closest('.edit_pad').hide();});$('.body').on('click','.j_rename_submit',function(e){var that=this;var name=$(that).closest('.edit_pad').find('input').val();var o;if(!(/^[^'"<>]{1,60}$/).test(name)){$(that).closest('.edit_pad').find('.tip_word').addClass('tip_fail').text('请输入正确的实例名称');}else{$(that).removeClass('btn_blue').addClass('btn_blue_loading').find('span').addClass('ico ico_loading_blue');o=qcloud.cdb.cvmList[$(that).closest('tr').attr('seq')];$.jsonPost({url:'/ajax/cdbImport/renameCdb.php',data:{moduleId:moduleId,instanceId:o.cdbInstId,cdbInstanceName:o.name,cdbInstanceNewName:name},sucCb:function(res){var _seq=$(that).closest('tr').attr('seq');$(that).closest('.edit_pad').hide();$('tr[seq='+_seq+']').find('.line_checkbox').html('<i class="ico ico_loading_black"></i>');qcloud.util.queryFlowResult({taskId:res.data.taskId,taskType:res.data.taskType,moduleId:moduleId,fnSuc:function(d){qcloud.util.showTips({text:"改名操作成功",timeToLive:1000});qcloud.cdb.getData();},fnErr:function(d){qcloud.util.showTips({type:"error",text:o.name+":改名操作失败"});qcloud.cdb.getData();}});},errCb:function(res){$(that).removeClass('btn_blue').addClass('btn_blue_loading').find('span').addClass('ico ico_loading_blue');if(res.retcode==9810){qcloud.util.showTips({type:"error",text:'操作失败，您未开通“管理云资源”权限，现在为您跳转首页'});setTimeout(function(){window.location.href=MAIN_DOMAIN;},3000);return;}else{$(that).closest('.edit_pad').find('.tip_word').addClass('tip_fail').text(res.errmsg||'系统繁忙，请稍后再试');}}});}});},num:function(el,status){var isPlaceholder=false;var num=60-el.value.length;if(!(/^[^'"<>]{1,60}$/).test(el.value)){$(el).closest('.edit_pad').find('.tip_word').addClass('tip_fail').text('请输入正确的实例名称');return;}
if("placeholder"in el){isPlaceholder=true;}
if(!$.trim(el.value).length&&1==status&&!isPlaceholder){el.value=el.getAttribute('placeholder');el.style.color='#aaa';el._empty=true;num=20;}
if(el._empty&&2==status){el.value='';el.style.color='#000';el._empty=false;num=20;}
$(el).closest('.edit_pad').find('.tip_word').removeClass('tip_fail').text('还能输入'+num+'个字符');},show:function(){var selectedCvms=qcloud.cvmCommon.getSelectedCvms();if(selectedCvms.length>0){qcloud.cdb.showRenameBox(selectedCvms);}}};qcloud.cdb.showRenameBox=function(cvm){if("1"==IS_LOCKED){qcloud.cdb.showChangingBox();return;}
if(!cvm){return;}
var me=qcloud.cdb,$renameBox=$('#pop_cdb_rename'),$submitBtn=$renameBox.find('.btn_submit');var form=$('form',$renameBox)[0];$submitBtn.removeClass('btn_blue_loading').addClass('btn_blue').find('span').removeClass('ico ico_loading_blue');qcloud.util.formValidate(form,function(val,status,el){if(!(/^[^'"<>]{1,60}$/).test(val)){$(el).parent().find('[_tip=warn] .bubble_i').html('<i class="ico ico_warn_17"></i>请输入正确的实例名称');return false;}
return true;},function(val,status,el){$(el).parent().parent().find('[_tip=warn]').hide();$submitBtn.removeClass('btn_white_2').addClass('btn_blue');},function(val,status,el){if(val.length||(!status.isOnBlur&&!status.isKeyUp)){$(el).parent().parent().find('[_tip=warn]').show();}else{$(el).parent().parent().find('[_tip=warn]').hide();}
$submitBtn.removeClass('btn_blue').addClass('btn_white_2');});$('#cdb_name').keydown(function(){$('#input_num_left').html(Math.max(0,20-this.value.length));}).keyup(function(){$('#input_num_left').html(Math.max(0,20-this.value.length));});var _tmpFn=function(_cvm){var _seq=$(me.cvmList).index(_cvm[0]);var ids=[];for(var i=_cvm.length-1;0<=i;i--){ids.push(_cvm[i].cdbInstId);}
if(1!==ids.length){return;}
qcloud.cvmCommon._initPopBox($renameBox,[]);$('#cdb_name').val(_cvm[0].name).keyup();$renameBox.floatdiv({location:"middle",isShowCover:true,confirm_callback:function(){form.validateAll();if(!$submitBtn.hasClass('btn_blue')){return;}
$submitBtn.removeClass('btn_blue').addClass('btn_blue_loading').find('span').addClass('ico ico_loading_blue');$.jsonPost({url:'/ajax/cdbImport/renameCdb.php',data:{moduleId:moduleId,instanceId:ids[0],cdbInstanceName:_cvm[0].name,cdbInstanceNewName:$('#cdb_name').val()},sucCb:function(res){$renameBox.closeFloatDiv();$('tr[seq='+_seq+']').find('.line_checkbox').html('<i class="ico ico_loading_black"></i>');qcloud.util.queryFlowResult({taskId:res.data.taskId,taskType:res.data.taskType,moduleId:moduleId,fnSuc:function(d){qcloud.util.showTips({text:"改名操作成功",timeToLive:1000});qcloud.cdb.getData();},fnErr:function(d){qcloud.util.showTips({type:"error",text:o.name+":改名操作失败"});qcloud.cdb.getData();}});},errCb:function(res){$submitBtn.removeClass('btn_blue_loading').addClass('btn_blue').find('span').removeClass('ico ico_loading_blue');qcloud.cvmCommon._popBoxErr($renameBox,res);}});},close_callback:function(){qcloud.cdb.mask.hide();}}).show();};_tmpFn(cvm);this.showRenameBox=_tmpFn;};qcloud.cdb.showReturnBox=function(){var selectedCvms=qcloud.cvmCommon.getSelectedCvms();var me=qcloud.cdb;var $box=$('#pop_return_back');var $submitBtn=$box.find('.btn_submit');var h=[];var nameList=[];if("1"==IS_LOCKED){qcloud.cdb.showChangingBox();return;}
qcloud.cvmCommon._initPopBox($box,[]);$.each(selectedCvms,function(k,v){h.push(['<tr>','<td>'+v.name+'</td>','<td>'+v.typeCn+'</td>','<td>'+v.ipAndPort+'</td>','</tr>'].join(''));nameList.push(v.name);});$box.find('tbody').html(h.join(''));$box.floatdiv({location:"middle",isShowCover:true,confirm_callback:function(){if(!$submitBtn.hasClass('btn_blue')){return false;}
$submitBtn.removeClass('btn_blue').addClass('btn_blue_loading').find('span').addClass('ico ico_loading_blue');$.jsonPost({url:'/ajax/offlineCdbInstance.php',data:{moduleId:me.moduleId,instanceNameList:nameList},sucCb:function(res){$box.closeFloatDiv();$('.bd_content_table .btn_selected_16').each(function(){$(this).closest('.line_checkbox').html('<i class="ico ico_loading_black"></i>');});qcloud.util.queryFlowResult({taskId:res.data.taskId,taskType:res.data.taskType,moduleId:moduleId,fnSuc:function(d){qcloud.util.showTips({text:"退还操作成功",timeToLive:1000});qcloud.cdb.getData();},fnErr:function(d){qcloud.util.showTips({type:"error",text:"退还操作失败"});qcloud.cdb.getData();}});},errCb:function(res){$submitBtn.removeClass('btn_blue_loading').addClass('btn_blue').find('span').removeClass('ico ico_loading_blue');qcloud.cvmCommon._popBoxErr($box,res);}});},close_callback:function(){qcloud.cdb.mask.hide();}}).show();};qcloud.cdb.getAllocProjectId=function(){var projId=0;var $box=$("#pop_distribute_project");projId=$box.find('tbody input:checked').closest('tr').attr('projectId');return projId;};qcloud.cdb.showProjectBox=function(){var selectedCvms=qcloud.cvmCommon.getSelectedCvms();var me=qcloud.cdb;var $box=$("#pop_distribute_project");var $submitBtn=$box.find('.btn_submit');var projectIdInCookie=$.cookie('projectId');var h=[];qcloud.cvmCommon._initPopBox($box,[]);$.each(me.projectList,function(k,v){var name=v['name'];var info=v['info'];var projectId=v['projectId'];h.push('<tr class="select_row" projectId="'+projectId+'"><td><input type="radio" name="rd_test"></td><td>'+name+'</td><td>'+qcloud.util.htmlEncode(info)+'</td><tr>');});$box.find('tbody').html(h.join(''));$box.find('[projectId='+projectIdInCookie+'] input').attr("checked","check");$box.find('.select_row').unbind().bind('click',function(){$(this).find('input').attr("checked","check");});$box.floatdiv({location:"middle",isShowCover:true,confirm_callback:function(){if(!$submitBtn.hasClass('btn_blue')){return false;}
var newProjectId=me.getAllocProjectId();var instanceList=[];$.each(selectedCvms,function(index,item){var cdbList={"projectId":parseInt(item.projectId),"newProjectId":parseInt(newProjectId),"instanceName":item.name};instanceList.push(cdbList);});$submitBtn.removeClass('btn_blue').addClass('btn_blue_loading').find('span').addClass('ico ico_loading_blue');$.jsonPost({url:'/ajax/cdb/ChangeCdbProject.php',data:{moduleId:me.moduleId,instanceArr:instanceList},sucCb:function(res){$box.closeFloatDiv();$('.bd_content_table .btn_selected_16').each(function(){$(this).closest('.line_checkbox').html('<i class="ico ico_loading_black"></i>');});qcloud.util.showTips({text:"分配项目成功",timeToLive:1000});qcloud.cdb.getData();},errCb:function(res){$submitBtn.removeClass('btn_blue_loading').addClass('btn_blue').find('span').removeClass('ico ico_loading_blue');qcloud.cvmCommon._popBoxErr($box,res);}});},close_callback:function(){qcloud.cdb.mask.hide();}}).show();};qcloud.cdb.showChangingBox=function(){if(IS_SETTIMESPAN=="1"){$('#changing_tip .btn_submit').attr('href','/deal/dealsConfirmDirect.php?isSwitch=1&switchType=cdb').find('span').text('立即支付');}else{$('#changing_tip .btn_submit').attr('href','/shoppingcart/cdbchange.php').find('span').text('切换到预付费');}
$('#changing_tip').floatdiv({location:"middle",isShowCover:true,confirm_callback:function(){var url=$('#changing_tip .btn_submit')[0].href;window.open(url,'_blank');},close_callback:function(){}}).show();};qcloud.cdb._checkOpsAvailable=function(){var me=qcloud.cdb;var selected=qcloud.cvmCommon.getSelectedCvms();var _hasDomain=false;var _setStatus=function(id,isEnable,title){$('#'+id).addClass(isEnable?"btn_blue":"btn_disable_v2").removeClass(isEnable?"btn_disable_v2":"btn_blue").attr("title",isEnable?"":title);};_setStatus("btn_rename",(1==selected.length),"请选择一个实例");_setStatus("btn_back",(1<=selected.length),"请选择一个或多个实例");_setStatus("btn_project",(1<=selected.length),"请选择一个或多个实例");};qcloud.cdb._sortList=function(sortId,sortType){var me=qcloud.cdb;var _sort=function(arr,attrs){var _attrs=attrs.split("|");arr.sort(function(a,b){for(var i=0,len=_attrs.length;i<len;i++){a=a[_attrs[i]];b=b[_attrs[i]];}
return me.sortType?b>a:a>b;});};this._sortList=function(sortId){me.sortId=sortId;me.sortType=sortType=='down'?1:0;_sort(me.cvmList,me.map[sortId]);me.createTable();};this._sortList(sortId);};qcloud.cdb.showcdbInfo=function(cdbInfo){var that=this;this._infoShowedId=cdbInfo.cdbInstId;$('#selected_info').html('<span style="padding-left:20px;">选中cdb实例：'+cdbInfo.name+'</span>');$('#srv_info_wrp').find('[_val]').each(function(){var attr=$(this).attr("_val");$(this).text(cdbInfo[that.map[attr]]);});$('#mod_monitor_frm .op_area a').show();setTimeout(function(){if(qcloud.cdb.__isBtn){return;}
$('#monitor_new_win')[0].href=MONITOR_DOMAIN+'/detail2/embed.php?type=cdb&val='+cdbInfo.cdbInstId+'&name='+cdbInfo.name;$('#ifr_srv_monitor')[0].src=$('#monitor_new_win')[0].href;if(!that.__imgInfoFirst){qcloud.cvmCommon.resizeSrvArea(2);that.__imgInfoFirst=true;}},50);};qcloud.cdb.tab=function(el,tabId){$('.j_server_tab').removeClass('selected');$(el).addClass('selected');$('#basic_info')[1===tabId?'show':'hide']();$('#srv_monitor_wrp')[2===tabId?'show':'hide']();};qcloud.cdb.pager={total:1,cur:1,numPerPage:20,events:function(){var that=this;$(document).on('keydown','#page_num',function(e){if(13==e.keyCode){that.change($(this).val());}});},set:function(cur,total){this.cur=cur;this.total=total;if(1>=total){$('#pager').html('<span class="page_text">1/1 页</span>');}else{$('#pager').html(['<span class="page_text">','第<input type="text" value="'+cur+'" id="page_num" class="input_style">/'+total+' 页','</span>','<a href="javascript:void(0);" onclick="qcloud.cdb.pager.change('+(cur-1)+', this);return false;" class="'+(1>=cur?'page_pre_disable':'page_pre')+'">','<span class="visually_hidden">上一页</span>','</a>','<a href="javascript:void(0);" onclick="qcloud.cdb.pager.change('+(cur+1)+', this);return false;" class="'+(total<=cur?' page_next_disable':'page_next')+'">','<span class="visually_hidden">下一页</span>','</a>'].join(''));}},get:function(offset){return this.cur;},change:function(pageNum,el){if(el&&0<=el.className.indexOf('disable')){return;}
if(!/^[\d]+$/.test(pageNum)||1>+pageNum||this.total<+pageNum){qcloud.util.showTips({type:'error',text:'请输入1-'+this.total+'之间的数字'});return;}
pageNum=+pageNum;pageNum=Math.max(pageNum,1);pageNum=Math.min(pageNum,this.total);this.set(pageNum,this.total);qcloud.cdb.cvmList=qcloud.cvmCommon.cvmList=qcloud.cdb.tempCdbList.slice((pageNum-1)*this.numPerPage,pageNum*this.numPerPage);qcloud.cdb.createTable();}};qcloud.cdb.search={events:function(){var s=this;$('#search_input').focus(function(){if(!this.isChanged){$(this).val('').css({'color':'#404a58'});}
$(this).css({'border':'1px solid #2496e6'}).parent().addClass('text_area_focus');}).blur(function(){if(!$.trim($(this).val()).length){$(this).val('请输入访问地址或名称(换行分隔)').css({'color':'#ababab'});this.isChanged=false;}else{this.isChanged=true;}
$(this).css({'border':'1px solid #b3b3b3'}).parent().removeClass('text_area_focus');});$('#btn_search').click(function(){setTimeout(function(){s.filt();},10);});$('#returnList a').click(function(){qcloud.cdb.pager.cur=1;qcloud.cdb.getData();$('#search_input').val('').blur();$('#search_type_btn span').text('所有类型');$('#returnList').hide();});},filt:function(){var ret=[];var input=$('#search_input')[0];var type=$('#search_type_btn span').text();var str=input.isChanged?input.value:'';var tmps;var i;if('所有类型'==type&&!$.trim(str)){$('#returnList a').click();}else{$('#returnList').show();tmps=str.split('\n');$.each(qcloud.cdb.wsList,function(){if('所有类型'!=type&&this.typeCn!=type){return;}
if(!$.trim(str)){ret.push(this);return;}
for(i=0;i<tmps.length;i++){if(!tmps[i].length){continue;}
if(0<=(''+this.name).indexOf(tmps[i])||0<=(''+this.ipAndPort).indexOf(tmps[i])){ret.push(this);}}});qcloud.cdb.isSearchResult=true;qcloud.cdb.cvmList=qcloud.cvmCommon.cvmList=qcloud.cdb.tempCdbList=ret;qcloud.cdb.pager.set(1,Math.ceil(qcloud.cdb.cvmList.length/qcloud.cdb.pager.numPerPage));qcloud.cdb.createTable();}}};qcloud.cdb.getReaionName=function(regionId){me=qcloud.cdb;return me.AreaMap[regionId];};qcloud.cdb.getFtpAddr=function(regionId){me=qcloud.cdb;return me.FtpAddr[regionId];};qcloud.cdb.changeLeftTab=function(ind,el){$('.j-tab-content').hide();$('#tab-content-'+ind).show();$('#tab-title').text(['实例列表','数据导入','数据导出'][ind]);$('#slide_nav li').removeClass('selected');$('#slide_nav li:eq('+ind+')').addClass('selected');$('#mod_content_wrapper')[1==ind?'hide':'show']();$('#data_import_area')[1==ind?'show':'hide']();window._isTableMode=(1==ind)?false:true;if(1==ind){qcloud.cdb.dataImport.init();qcloud.cdb.getFileListAndFtp();$('#muti_area2').val($.cookie("regionId"));$(window).trigger('resize');}else{$('#muti_area').val($.cookie("regionId"));qcloud.cdb.getData();$(window).trigger('resize');}};qcloud.cdb._validateDbPw=function($input,$box){if(qcloud.util.validateCdbPwd($input.val())){$input.css('border-color','');$box.find('.tip_error').text('');return true;}else{$input.css('border-color','#BB4336');$box.find('.tip_error').text('请正确输入密码').show();return false;}};qcloud.cdb.dbInitValidate=function($pw,$pwRp,$box){if(!this._validateDbPw($pw,$box)||!this._validateDbPw($pwRp,$box)){return false;}
if($pw.val()!=$pwRp.val()){$box.find('.tip_error').text('您两次输入的密码不一致');return false;}else{$box.find('.tip_error').text('');return true;}};qcloud.cdb.phpAdmin=function(ind){var data=qcloud.cvmCommon.cvmList[ind];window.open('/cdb_redirect.php?moduleId='+moduleId+'&instanceId='+data.instanceId+'&instanceName='+data.name+'&vip='+data.vip+'&vport='+data.vport,'_blank');};qcloud.cdb.showDbInitBox=function(ind){var data=qcloud.cvmCommon.cvmList[ind];var me=qcloud.cdb;var $box=$('#db_init_box');var $submitBtn=$box.find('.btn_submit');var $pw=$('#db_init_pw');var $pwRp=$('#db_init_pw_rp');if("1"==IS_LOCKED){qcloud.cdb.showChangingBox();return;}
qcloud.cvmCommon._initPopBox($box,[]);$submitBtn.removeClass('btn_white_2').addClass('btn_blue');$('#db_init_name').text(data.name);$pw[0].onblur=function(){if(0<this.value.length){me._validateDbPw($pw,$box);}};$pwRp[0].onblur=function(){if(0<this.value.length){me._validateDbPw($pwRp,$box);}};$box.floatdiv({location:"middle",isShowCover:true,confirm_callback:function(){if(!me.dbInitValidate($pw,$pwRp,$box)){return false;}
$submitBtn.removeClass('btn_blue').addClass('btn_blue_loading').find('span').addClass('ico ico_loading_blue');var token=$.getACSRFToken()+'';$.jsonPost({url:'/ajax/CdbCharset/initCdbSet.php',data:{instanceId:data.cdbInstId,cdbInstanceName:data.name,charset:$box.find(".rd_charset_init:checked").attr('_value'),cdbPwd:stringToHex(des(token,$pw.val(),1)),cdbPwdConfirm:stringToHex(des(token,$pwRp.val(),1))},sucCb:function(res){$box.closeFloatDiv();qcloud.util.showTips({type:"succeed",text:"初始化CDB实例成功。",timeToLive:1000});me.getData();},errCb:function(res){$submitBtn.removeClass('btn_blue_loading').addClass('btn_blue').find('span').removeClass('ico ico_loading_blue');qcloud.cvmCommon._popBoxErr($box,res);}});},close_callback:function(){qcloud.cdb.mask.hide();}}).show();};qcloud.cdb.showDbCfgBox=function(ind){var data=qcloud.cvmCommon.cvmList[ind];var me=qcloud.cdb;var $box=$('#cd_cfg_box');var $submitBtn=$box.find('.btn_submit');if("1"==IS_LOCKED){qcloud.cdb.showChangingBox();return;}
qcloud.cvmCommon._initPopBox($box,[]);$submitBtn.removeClass('btn_white_2').addClass('btn_blue');$('#db_cfg_name').text(data.name);$('#db_cfg_ip').text(data.ipAndPort);$('#db_cfg_type').text(data.typeCn);$('#db_cfg_version').text('MySQL '+(data.mysqlVersion||'5.1'));$('.db_cfg_char').each(function(){if(data.charset==$(this).attr('_value')){this.checked=true;}});$('#reset_pw_apply').click(function(){$box.closeFloatDiv();qcloud.cdb.showChangePwApplyBox(ind);});$box.floatdiv({location:"middle",isShowCover:true,confirm_callback:function(){$submitBtn.removeClass('btn_blue').addClass('btn_blue_loading').find('span').addClass('ico ico_loading_blue');$.jsonPost({url:'/ajax/CdbCharset/UpdateCdbCharset.php',data:{moduleId:moduleId,instanceId:data.cdbInstId,cdbInstanceName:data.name,charset:$box.find(".db_cfg_char:checked").attr('_value'),},sucCb:function(res){$box.closeFloatDiv();$('tr[seq='+ind+']').find('.line_checkbox').html('<i class="ico ico_loading_black"></i>');qcloud.util.queryFlowResult({taskId:res.data.taskId,taskType:res.data.taskType,moduleId:moduleId,fnSuc:function(d){qcloud.util.showTips({text:"字符集修改成功",timeToLive:1000});qcloud.cdb.getData();},fnErr:function(d){qcloud.util.showTips({type:"error",text:"字符集修改失败，请稍后再试"});qcloud.cdb.getData();}});},errCb:function(res){$submitBtn.removeClass('btn_blue_loading').addClass('btn_blue').find('span').removeClass('ico ico_loading_blue');qcloud.cvmCommon._popBoxErr($box,res);}});},close_callback:function(){qcloud.cdb.mask.hide();}}).show();};qcloud.cdb.showXFeebox=function(ind){var data=qcloud.cvmCommon.cvmList[ind];var me=qcloud.cdb;var $box=$('#cdb_xfee_box');var $submitBtn=$box.find('.btn_submit');var _getDateCn=function(str){var tmp=str.split(/\s+/)[0].split('-');var d=new Date(tmp[0],+tmp[1]-1,tmp[2]);return d.getFullYear()+' 年 '+('00'+(d.getMonth()+1)).slice(-2)+' 月 '+('00'+d.getDate()).slice(-2)+' 日';};if("1"==IS_LOCKED){qcloud.cdb.showChangingBox();return;}
qcloud.cvmCommon._initPopBox($box,[]);$submitBtn.removeClass('btn_white_2').addClass('btn_blue');$('#cdb_xfee_end').text(_getDateCn(data.deadline));$('#cdb_xfee_name').text(data.name);$('#cdb_xfee_addr').text(data.ipAndPort);$('#cdb_xfee_val')[0].onchange=function(){var val=$('#cdb_xfee_val').val();$.jsonGetter({url:"/ajax/shoppingcart/queryPrice.php",data:{goodsInfoArray:[{goodsCategoryId:17,goodsDetail:{type:'cdb',subType:data.type,action:'ApplyCdb',appid:moduleId,goodsNum:1,payMode:1,regionId:1,timeSpan:val},goodsNum:1}],payMode:1},sucCb:function(res){var priceObj=res.data[0];$('#cdb_xfee_total').html('<strong class="text_stress">'+(priceObj.realTotalCost/100).toFixed(2)+'</strong> 元');if(priceObj.discount==10){$('#renew_discount').hide();$('#renew_no_discount').show();}else{$('#txt_renew_paid_ori').text((priceObj.totalCost/100).toFixed(2));$('#txt_renew_paid').text((priceObj.realTotalCost/100).toFixed(2));$('#renew_no_discount').hide();$('#renew_discount').show();}},errCb:function(){$('#cdb_xfee_total').text('获取失败,请稍后再试。');}});};$('#cdb_xfee_total').html('<strong class="text_stress">--</strong> 元');if("0"!=$('#cdb_xfee_type').val()){$('#cdb_xfee_type').val("0").trigger('change');}else{$('#cdb_xfee_val').val("12")[0].onchange();}
$box.floatdiv({location:"middle",isShowCover:true,confirm_callback:function(){var _data=[{"goodsCategoryId":18,"goodsNum":1,"payMode":1,"goodsDetail":{"type":"cdb","subType":data.type,"action":"renewCdb","instanceName":data.name,"goodsNum":1,"payMode":1,"regionId":REGION_ID,"curDeadline":data.deadline,"timeSpan":$('#cdb_xfee_val').val()}}];$.cookie('qcloud_ck_quick',$.toJSON({"raw_goodsData":_data}),{expires:1,path:'/',domain:COOKIE_DOMAIN});window.open('/deal/dealsConfirmDirect.php','_blank');$box.closeFloatDiv();},close_callback:function(){qcloud.cdb.mask.hide();}}).show();};qcloud.cdb.getCdbResetInfo=function(){$.jsonGetter({url:"/ajax/cdb_forget_password.php",data:{moduleId:moduleId},sucCb:function(res){$('#fg_pw_email, #e_c_b_email').text(res.userEmail);$("#fg_pw_vcode_img, #reset_pw_vcode_img").attr('src',res['vcodeUrl']+"&"+Math.random());$('#fg_pw_vcode, #reset_pw_vcode').unbind().click(function(){$("#fg_pw_vcode_img, #reset_pw_vcode_img").attr('src',res['vcodeUrl']+"&"+Math.random());});}});};qcloud.cdb.showChangePwApplyBox=function(ind){var data=qcloud.cvmCommon.cvmList[ind];var me=qcloud.cdb;var $box=$('#cd_forget_pw');var $submitBtn=$box.find('.btn_submit');qcloud.cvmCommon._initPopBox($box,[]);$submitBtn.removeClass('btn_white_2').addClass('btn_blue');$('#fg_pw_name').text(data.name);$('#fg_pw_accout').text('app'+moduleId);me.getCdbResetInfo();$box.floatdiv({location:"middle",isShowCover:true,confirm_callback:function(){$submitBtn.removeClass('btn_blue').addClass('btn_blue_loading').find('span').addClass('ico ico_loading_blue');var vcode=$.trim($('#fg_pw_vcode_input').val());if(4!=vcode.length){$box.find('.tip_error').text('验证码错误，请重新输入');}else{$box.find('.tip_error').text('');}
$.jsonPost({url:'/ajax/cdb_reset_password.php',data:{moduleId:moduleId,instanceId:data.cdbInstId,instanceName:name,vcode:vcode},sucCb:function(res){$box.closeFloatDiv();$('#email_confirm_box').floatdiv({location:"middle",isShowCover:true}).show();},errCb:function(res){$submitBtn.removeClass('btn_blue_loading').addClass('btn_blue').find('span').removeClass('ico ico_loading_blue');qcloud.cvmCommon._popBoxErr($box,res);}});},close_callback:function(){qcloud.cdb.mask.hide();}}).show();};qcloud.cdb.initResetPwd=function(){var me=qcloud.cdb;if(instanceId&&timestamp>0){var cdb=me.getFromArr(qcloud.cvmCommon.cvmList,'cdbInstId',instanceId);qcloud.cvmCommon.cvmList=cdb?[cdb]:[];me.createTable();if(!cdb){$('.table_blank').find('.text').html('该实例已经不存在');}else{qcloud.cdb.showResetPwBox(instanceId,timestamp,cdb);}}};qcloud.cdb.showResetPwBox=function(instanceId,timestamp,cdb){var data=cdb;var me=qcloud.cdb;$('#reset_pw_vcode').click(function(){$("#reset_pw_vcode_img").attr('src',vcodeUrl+"&"+Math.random());}).click();var $box=$('#reset_pw_box');var $submitBtn=$box.find('.btn_submit');qcloud.cvmCommon._initPopBox($box,[]);$submitBtn.removeClass('btn_white_2').addClass('btn_blue');$('#reset_pw_name').text(data.name);$('#reset_pw_accout').text('app'+moduleId);$box.floatdiv({location:"middle",isShowCover:true,confirm_callback:function(){if(!$submitBtn.hasClass('btn_blue')){return;}
$('input[type="password"]').each(function(index,elem){me._checkPwdInput(elem);});var isEqualed=me._isPwdEqualed();if(!isEqualed){$box.find('.tip_error').text('请正确输入密码').show();return;}else{$box.find('.tip_error').text('').hide();}
var vcode=$.trim($('#reset_pw_vcode_input').val());if(4!=vcode.length){$box.find('.tip_error').text('验证码错误，请重新输入').show();return;}else{$box.find('.tip_error').text('').hide();}
$submitBtn.removeClass('btn_blue').addClass('btn_blue_loading').find('span').addClass('ico ico_loading_blue');var token=$.getACSRFToken()+'';$.jsonPost({url:'/ajax/cdb_modify_password.php',data:{moduleId:moduleId,instanceId:data.cdbInstId,newPassword:stringToHex(des(token,$('input[type="password"]').filter('[name=new_password]').val(),1)),timestamp:timestamp,vcode:vcode},sucCb:function(res){$box.closeFloatDiv();$('#pwd_reset_suc_box').floatdiv({location:"middle",isShowCover:true,confirm_callback:function(){window.location.href='/cdb_list.php';}}).show();},errCb:function(res){$submitBtn.removeClass('btn_blue_loading').addClass('btn_blue').find('span').removeClass('ico ico_loading_blue');qcloud.cvmCommon._popBoxErr($box,res);}});},close_callback:function(){window.location.href='/cdb_list.php';qcloud.cdb.mask.hide();}}).show();};qcloud.cdb._checkPwdInput=function(elem){$(elem).removeClass("input_focus");var checked=qcloud.util.validateCdbPwd($(elem).val());var isEqualed=qcloud.cdb._isPwdEqualed();if($(elem).attr("name")=="new_password"){if(!checked){$(elem).addClass("input_error");$(elem).closest('div').find(".msg_error").show();$(elem).closest('div').find(".ico_right").hide();}else{$(elem).removeClass("input_error");$(elem).closest('div').find(".msg_error").hide();$(elem).closest('div').find(".ico_right").show();if(isEqualed){$('input[type="password"]').filter('[name=re_password]').closest('div').find(".msg_error").hide();}}}else{if(!isEqualed){$(elem).addClass("input_error");$(elem).closest('div').find(".msg_error").show();$(elem).closest('div').find(".ico_right").hide();}else{$(elem).removeClass("input_error");$(elem).closest('div').find(".msg_error").hide();$(elem).closest('div').find(".ico_right").show();}}};qcloud.cdb._isPwdEqualed=function(){var pwda=$('input[type="password"]').filter('[name=new_password]').val();var pwdb=$('input[type="password"]').filter('[name=re_password]').val();return qcloud.util.validateCdbPwd(pwda)&&qcloud.util.validateCdbPwd(pwdb)&&pwda==pwdb;};window.qcloud.cdbTmpl='<% for( var i=0, len=list.length; i<len; i++ ){ %><% if( 1 == i%2 ){ %><tr class="odd" seq="<%=i%>"><% }else{ %><tr seq="<%=i%>"><% } %><td class="line_checkbox"><a href="javascript:void(0);" onclick="return false;" class="btn_select_16"><span class="visually_hidden">checkbox</span></a></td><% for( var _i=0,_len=titles.length; _i<_len; _i++  ){ %><%if( \'cdb_name\' == titles[_i].id ){%><td class="name"><div class="name_text"><span title="<%= list[i][ titles[_i].id ] %>" class="text textoverflow"><%= list[i][ map[ titles[_i].id ] ] %></span><a class="ico ico_edit_20 j_btn_edit" href="javascript:void(0);" onclick="return false;" title="编辑" style="display: none;"></a><div class="edit_pad" style="min-height:90px;height:auto;display: none;"><input type="text" class="input_style" maxlength="60" onkeydown="qcloud.cdb.rename.num(this);" onkeyup="qcloud.cdb.rename.num(this);" onblur="qcloud.cdb.rename.num(this,1);" onfocus="qcloud.cdb.rename.num(this,2);" value="test" placeholder="60个字以内中英文,数字,连接符-"><p><span class="tip_word">还能输入<span class="num"></span>个字符</span><span class="op"><a class="btn btn_blue j_rename_submit" href="javascript:void(0);" onclick="return false;"><span>保存</span></a><a class="link j_rename_cancel" href="javascript:void(0);" onclick="return false;">取消</a></span></p></div></div></td><%}else if( \'cdb_charset\' == titles[_i].id ){%><td><div class="name_text"><span title="<%= list[i][ titles[_i].id ] %>" _charset="<%= list[i].cdbInstId %>" class="text textoverflow"><%= list[i][ map[ titles[_i].id ] ] || "—" %></span></div></td><%}else if( \'cdb_end_time\' == titles[_i].id ){%><%if( 7 < list[i].leftTime ){%><td><div class="name_text"><span title="<%= list[i][ titles[_i].id ] %>" class="text textoverflow"><%= list[i][ map[ titles[_i].id ] ] || "—" %></span></div></td><%}else if( 0 < list[i].leftTime ){%><td><div class="name_text"><span title="<%= list[i][ titles[_i].id ] %>" style="color:#f80;" class="text textoverflow"><%= list[i][ map[ titles[_i].id ] ] || "—" %></span></div></td><%}else{%><td><div class="name_text"><span title="<%= list[i][ titles[_i].id ] %>" style="color:#f30;" class="text textoverflow">已过期，<%=7+list[i].leftTime%>天后回收</span></div></td><%}%><%}else if( \'operation\' == titles[_i].id ){%><%if( isPaid ){%><%if( 7 < list[i].leftTime ){%><td><div class="name_text"><span class="text text_link"><%if( 1 == list[i].initFlag ){%><a href="javascript:void(0);" onclick="qcloud.cdb.phpAdmin(<%=i%>);return false;" class="link">phpMyAdmin</a><a href="javascript:void(0);" onclick="qcloud.cdb.showDbCfgBox(<%=i%>);return false;" class="link">配置</a><%}else{%><a href="javascript:void(0);" onclick="qcloud.cdb.showDbInitBox(<%=i%>);return false;" _init="0" style="color:#f60;" class="link">配置初始密码</a><%}%><a href="javascript:void(0);" onclick="qcloud.cdb.showXFeebox(<%=i%>);return false;" class="link">续费</a></span></div></td><%}else if( 0 < list[i].leftTime ){%><td><div class="name_text"><span class="text text_link"><%if( 1 == list[i].initFlag ){%><a href="javascript:void(0);" onclick="qcloud.cdb.phpAdmin(<%=i%>);return false;" class="link">phpMyAdmin</a><a href="javascript:void(0);" onclick="qcloud.cdb.showDbCfgBox(<%=i%>);return false;" class="link">配置</a><%}else{%><a href="javascript:void(0);" onclick="qcloud.cdb.showDbInitBox(<%=i%>);return false;" _init="0" style="color:#f60;" class="link">配置初始密码</a><%}%><a href="javascript:void(0);" style="font-weight:bold;color:#f80;" onclick="qcloud.cdb.showXFeebox(<%=i%>);return false;" class="link">续费</a></span></div></td><%}else{%><td><div class="name_text"><span class="text text_link"><a href="javascript:void(0);" style="font-weight:bold;color:#f30;" onclick="qcloud.cdb.showXFeebox(<%=i%>);return false;" class="link">立即续费</a></span></div></td><%}%><%}else{%><td><div class="name_text"><span class="text text_link"><%if( 1 == list[i].initFlag ){%><a href="javascript:void(0);" onclick="qcloud.cdb.phpAdmin(<%=i%>);return false;" class="link">phpMyAdmin</a><a href="javascript:void(0);" onclick="qcloud.cdb.showDbCfgBox(<%=i%>);return false;" class="link">配置</a><%}else{%><a href="javascript:void(0);" onclick="qcloud.cdb.showDbInitBox(<%=i%>);return false;" _init="0" style="color:#f60;" class="link">配置初始密码</a><%}%></span></div></td><%}%><%}else{%><td><div class="name_text"><span title="<%= list[i][ titles[_i].id ] %>" class="text textoverflow"><%= list[i][ map[ titles[_i].id ] ] || "—" %></span></div></td><%}%><% } %></tr><% } %>';/*  |xGv00|6d3b6c0bc90385c0ceaa5919d4030ad5 */